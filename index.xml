<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Heaven Is</title><link>https://collect.fn.pub/</link><description>Recent content on Heaven Is</description><generator>Hugo -- gohugo.io</generator><language>zh-hans</language><copyright>unlicense yet.</copyright><lastBuildDate>Thu, 09 Nov 2023 15:38:01 +0800</lastBuildDate><atom:link href="https://collect.fn.pub/" rel="self" type="application/rss+xml"/><item><title>ç½‘ç»œã€æŠ€æœ¯ä¸é“å¾·</title><link>https://collect.fn.pub/2023/11-09-network-morality/</link><pubDate>Thu, 09 Nov 2023 15:38:01 +0800</pubDate><guid>https://collect.fn.pub/2023/11-09-network-morality/</guid><description>&lt;p>å°è¯•ç”¨ Outline æ¥å†™ä¸€äº›ä¸œè¥¿ï¼Œå¯èƒ½æœ‰ç‚¹ç ´å blog çš„åè°ƒæ€§ï¼›ä»¥åå¯èƒ½æä¸ª sync è„šæœ¬ä¹‹ç±»çš„å®šæœŸåŒæ­¥ä¼šæ›´å¥½ï¼Ÿç›®å‰è¿™é‡Œå°±å…ˆå½“ä½œ Index Home äº†ï¼ˆé€ƒã€‚&lt;/p></description></item><item><title>æ··ä¹±ä¸­ç«‹ä¸ Emacs</title><link>https://collect.fn.pub/2023/06-18-weird-emacs-workflow/</link><pubDate>Sun, 18 Jun 2023 14:46:01 +0800</pubDate><guid>https://collect.fn.pub/2023/06-18-weird-emacs-workflow/</guid><description>
&lt;p>
&lt;img src="https://cdn.pixabay.com/photo/2018/09/22/11/21/cat-3695040_1280.jpg" alt="https://cdn.pixabay.com/photo/2018/09/22/11/21/cat-3695040_1280.jpg" title="https://cdn.pixabay.com/photo/2018/09/22/11/21/cat-3695040_1280.jpg" />&lt;/p>
&lt;div id="outline-container-headline-1" class="outline-2">
&lt;h2 id="headline-1">
Semiannual
&lt;/h2>
&lt;div id="outline-text-headline-1" class="outline-text-2">
&lt;p>
å†å²ï¼ˆæŠ˜è…¾å²ï¼‰æ€»æ˜¯å¦‚æ­¤çš„å¾ªç¯ï¼Œä¸»åŠ›è¿ç§»åˆ°äº† CLion + IdeaVIMï¼Œå› æ­¤åŸæ¥çš„ Prelude å’Œ Modalka åŸºæœ¬éƒ½åºŸå¼ƒäº†ï¼Œé‡æ–°åŸºäº doomemacs å°å°åœ°æ”¹é€ äº†ä¸€ä¸‹ï¼Œç›®å‰å°† Emacs å®šä½ç»ˆç«¯ä»¥åŠ VSCode çš„æ›¿ä»£å“ï¼Œä½†å°±ç´¢å¼•ã€é‡æ„è¿™æ–¹é¢çš„èƒ½åŠ›æ¥è¯´è¿˜æ˜¯æ›´åŠ è§‰å¾— CLion æ›´å¥½ï¼Œå°¤å…¶æ˜¯ç°åœ¨ Nova è§£å†³äº†é¥±å—è¯Ÿç—…çš„å†…å­˜å’Œæ€§èƒ½é—®é¢˜ã€‚&lt;/p>
&lt;p>
å¦å¤–è¿˜æ˜¯æ‹¥æŠ±äº† Evilï¼Œå°†å®ƒæ›¿æ¢æ‰äº† Modalkaï¼Œä¸è¿‡ä¹Ÿå› æ­¤å°† Insert State æ›´æ”¹ä¸ºäº† Emacs Stateï¼Œè¿™æ ·åœ¨è¾“å…¥çš„æ—¶å€™å°±èƒ½åˆ‡æ¢å› Emacs çš„å¿«æ·é”®ï¼Œä¸æ˜¯å¾ˆ niceï¼Œä½†æ˜¯ worksğŸ˜‰ã€‚&lt;/p>
&lt;p>
è¿™ç¯‡è®°å½•å˜›ï¼Œè¿˜æ˜¯å°±æ”¾åœ¨è¿™é‡Œäº†ï¼ˆï¼Œè¯´ä¸å®šä»¥åå›è¿‡å¤´æ¥çœ‹è‡ªå·±çš„æŠ˜è…¾åŠ²è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ã€‚&lt;/p>
&lt;/div>
&lt;/div>
&lt;div id="outline-container-headline-2" class="outline-2">
&lt;h2 id="headline-2">
Why Emacs
&lt;/h2>
&lt;div id="outline-text-headline-2" class="outline-text-2">
&lt;p>
äººç±»å…³äº Emacsã€Vim ç”šè‡³æ˜¯ VSCode çš„äº‰è®®ä»æœªä¼‘æ­¢ï¼Œæ¯•ç«Ÿå·¥å…·å¾€å¾€è·Ÿæ•ˆç‡å…³ç³»å¯†åˆ‡ã€‚å¯¹æˆ‘è€Œè¨€ï¼Œèµ·åˆåªæ˜¯æƒ³è¯•ä¸€è¯•ä¼ é—»ä¸­çš„ Emacsï¼Œçœ‹å®ƒåˆ°åº•æœ‰å‡ åˆ†å¨åŠ›ï¼Œåœ¨æŠ˜è…¾è¿‡å¦‚&lt;a href="https://github.com/redguardtoo/emacs.d">é™ˆæ–Œ&lt;/a>å¤§ä½¬ã€&lt;a href="https://github.com/doomemacs/doomemacs">Doom Emacs&lt;/a> ç­‰ç­‰é…ç½®ä¹‹åï¼Œé€æ¸å¼€å§‹æœ‰ç‚¹â€œä¸Šå¤´â€ï¼Œå¼€å§‹å°†æ—¥å¸¸å·¥ä½œæµéƒ½è¿ç§»åˆ° Emacs ä¸Šå»ã€‚&lt;/p>
&lt;p>
å¯¹æˆ‘æ¥è¯´ï¼ŒEmacs æœ‰è¿™ä¹ˆå‡ ä¸ªæœ‰æ„æ€çš„ç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>å‡ ä¹æ‰€æœ‰çš„ bufferã€å‡½æ•°ã€å˜é‡ç­‰ç­‰éƒ½æ˜¯å…±äº«çš„ï¼Œè¿™è®© hack å˜å¾—è½»æ¾&lt;/li>
&lt;li>Emacs Lisp æœ‰ç€å¾ˆä¸é”™çš„è¡¨è¾¾èƒ½åŠ›ï¼Œé…åˆå„ç§æ–‡æœ¬å‡½æ•°ï¼Œå¾ˆè½»æ˜“åœ°å¯ä»¥å†™å‡ºè‡ªå·±æƒ³è¦çš„åŠŸèƒ½&lt;/li>
&lt;li>ä¸ºäº†è®©ä½ èƒ½æ›´èˆ’æœçš„ hackingï¼Œç”šè‡³æä¾›äº†å¦‚ &lt;code>advice-add&lt;/code> è¿™æ ·çš„ hijack åŠŸèƒ½&lt;/li>
&lt;/ol>
&lt;p>åœ¨æˆ‘çœ‹æ¥ï¼ŒEmacs å‡ ä¹å°±æ˜¯ä¸ºäº†è®©ä½ æŠ˜è…¾å®ƒè€Œè¯ç”Ÿçš„ï¼Œæ‰“å¼€ Emacs æ€»ä¼šä¸è‡ªè§‰åœ°å¼€å¯ &lt;code>.emacs.d&lt;/code> æ–‡ä»¶å¤¹ï¼ˆç¬‘ï¼‰ï¼Œæ¯•ç«Ÿï¼Œå½“ä½ ç”¨çš„ä¸çˆ½çš„æ—¶å€™ï¼ŒEmacs çœŸçš„å…è®¸ä½ å»ä¿®æ”¹ã€‚&lt;/p>
&lt;p>
å½“ç„¶ï¼Œè¿‡åº¦çš„çµæ´»æ€§ä¹Ÿæ˜¯ Emacs çš„æœ€å¤§ç¼ºç‚¹ï¼å®ƒè¿èƒŒäº† UNIX å“²å­¦ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Make each program do one thing well. To do a new job, build afresh rather than complicate old programs by adding new &amp;#34;features&amp;#34;.&lt;/p>
&lt;/blockquote>
&lt;p>
Emacs ä½œä¸ºæ–‡æœ¬ç¼–è¾‘å™¨æ˜¯ä¸å¤Ÿâ€œçº¯ç²¹â€çš„ï¼Œä½†æˆ‘ä¸ªäººè®¤ä¸ºï¼Œæ¨¡å—åŒ–è®¾è®¡è·Ÿæ•ˆç‡æœ‰ç€å¤©ç„¶çš„å†²çªï¼Œé€‰æ‹© Emacs å°±éœ€è¦æ¥æ”¶æ¨¡å—åŒ–ä¸å¤Ÿçš„é—®é¢˜ã€‚å°±åƒå¤§å®¶åå¥½ä½¿ç”¨ IDE ä¸€æ ·ï¼Œæ•ˆç‡çš„æ¥æºå¾€å¾€å°±æ˜¯å¤šä¸ªå°æ¨¡å—çš„æ‹¼åˆã€‚&lt;/p>
&lt;/div>
&lt;/div>
&lt;div id="outline-container-headline-3" class="outline-2">
&lt;h2 id="headline-3">
help-with-tutorial
&lt;/h2>
&lt;div id="outline-text-headline-3" class="outline-text-2">
&lt;p>
å®é™…ä¸Š Emacs ä½ åªéœ€è¦æŒæ¡ &lt;code>M-x&lt;/code> è¿™ä¹ˆä¸€ä¸ªå¿«æ·é”®å°±å¯ä»¥äº†ï¼ˆè®¤çœŸè„¸ï¼‰ï¼Œå‡ ä¹æ‰€æœ‰çš„å¿«æ·é”®éƒ½æ˜¯åœ¨æ‰§è¡ŒæŸä¸ª &lt;code>(interactive)&lt;/code> å‘½ä»¤ã€‚æ¯”å¦‚ &lt;code>C-n&lt;/code> å°±æ˜¯ &lt;code>next-line&lt;/code> ï¼Œ &lt;code>C-s&lt;/code> å°±æ˜¯ &lt;code>isearch-forward&lt;/code> ï¼Œå¦‚æ­¤ã€‚&lt;/p>
&lt;p>
æˆ‘è‡ªå·±å¯¹ Vim å®é™…ä¸Šä¸æ˜¯å¾ˆç†Ÿï¼Œè¿ &lt;code>ciw&lt;/code> è¿™ç§è¿™ä¹ˆå¥½ç”¨çš„å‘½ä»¤æˆ‘éƒ½æ˜¯å­¦ Emacs çš„æ—¶å€™å‘ç°çš„ï¼Œå› æ­¤é€‰æ‹©äº†èµ°ä¸€é &lt;code>help-with-tutorial&lt;/code> ï¼›å¦‚æœä½ æ¯”è¾ƒç†Ÿæ‚‰ Vim çš„è¯å¯ä»¥ç›´æ¥ä½¿ç”¨ Doom Emacs é…ç½®æ¥å¿«é€Ÿå…¥é—¨ã€‚&lt;/p>
&lt;p>
å½“ç„¶ï¼Œè¿˜æœ‰å¿…ä¸å¯å°‘çš„ Emacs Lispï¼Œè¿™ä¸ªè¯­è¨€å¯èƒ½å¯¹ä¹ æƒ¯ç±» C è¯­è¨€çš„äººæ¥è¯´ä¼šå¾ˆä¸é€‚åº”ï¼Œæˆ‘æ„Ÿè§‰æ˜¯è·Ÿå‡½æ•°å¼ç±»çš„è¯­è¨€æ›´ä¸ºæ¥è¿‘ï¼ˆè™½ç„¶å¤šæ•°æ—¶å€™éƒ½æ˜¯æŒ‰è¿‡ç¨‹å¼çš„æ€ç»´åœ¨å†™ hhhhï¼‰ã€‚æ¯”å¦‚ï¼š&lt;/p>
&lt;ol>
&lt;li>æ²¡æœ‰ &lt;code>return&lt;/code> è¿™æ ·çš„ä¸œä¸œï¼Œå‡½æ•°çš„è¿”å›å€¼å°±æ˜¯æœ€å eval çš„è¡¨è¾¾å¼çš„å€¼&lt;/li>
&lt;li>æœ€åŸºç¡€çš„æ•°ç»„å’Œ dict ä¹‹ç±»çš„æ•°æ®ç»“æ„è¡¨è¾¾åå‘å‡½æ•°å¼ï¼ˆä¾‹å¦‚ &lt;code>car/cdr&lt;/code> è¿™æ ·çš„å‡½æ•°ï¼‰&lt;/li>
&lt;li>æ‹¬å·å¤ªå¤šï¼ˆé›¾ï¼‰&lt;/li>
&lt;li>Many, many more&lt;/li>
&lt;/ol>
&lt;p>æˆ‘çš„åšæ³•æ˜¯ç…§è‘«èŠ¦ç”»ç“¢ï¼Œå› ä¸ºæˆ‘è‡ªèº«å­¦è¿‡ä¸€å®šçš„ Haskell è¿™ç±»å‡½æ•°å¼è¯­è¨€ï¼Œä¸Šæ‰‹èµ·æ¥æ²¡æœ‰å¤ªå¤šé—®é¢˜ã€‚å¦‚æœè§‰å¾— hack èµ·æ¥æœ‰ç‚¹å›°éš¾çš„è¯ï¼Œå¯ä»¥å‚è€ƒ &lt;a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/index.html">Emacs Lisp æ‰‹å†Œ&lt;/a>æ¥å­¦ä¹ ä¸€ä¸‹ï¼Œæˆ–è€…åˆ«å¿˜äº†è¿˜æœ‰ ChatGPT å¯ä»¥åˆ©ç”¨ã€‚&lt;/p>
&lt;p>
P.S. å¯èƒ½ Emacs çš„ Common Lisp æ‰©å±•ä¼šè®©æ•²ä»£ç çš„ä½“éªŒå¥½ä¸€äº›ï¼Œæ— è´£ä»»æ¨èï¼ˆã€‚&lt;/p>
&lt;/div>
&lt;/div>
&lt;div id="outline-container-headline-4" class="outline-2">
&lt;h2 id="headline-4">
Prelude|Postlude
&lt;/h2>
&lt;div id="outline-text-headline-4" class="outline-text-2">
&lt;p>
åœ¨å°è¯•äº†å¾ˆå¤šé…ç½®ä¹‹åï¼Œéƒ½æ„Ÿè§‰ä¸æ˜¯å¾ˆâ€œè´´åˆâ€è‡ªå·±ï¼Œå°¤å…¶æ˜¯å¤§å®¶ä¼¼ä¹éƒ½å¾ˆå–œæ¬¢ Evilï¼Œä½†æˆ‘è‡ªå·±æ›´åçˆ±åŸç”Ÿçš„é”®ä½ï¼Œå› ä¸ºå®ƒæ³›ç”¨æ€§æ¯”è¾ƒå¼ºï¼Œåœ¨ &lt;code>bash/zsh&lt;/code> è¿™ç±»ç»ˆç«¯ä¸‹é»˜è®¤å°±å¯ä»¥ä½¿ç”¨ã€‚å› æ­¤æ•²å®šäº† &lt;a href="https://github.com/hartlottery/postlude">Prelude&lt;/a> ä½œä¸ºæ¡†æ¶ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šä¿®æ”¹ã€‚&lt;/p>
&lt;p>
æˆ‘è‡ªå·±çš„ä¸€äº›â€œæ‰€è°“çš„â€å“²å­¦ç†å¿µï¼ˆå¯èƒ½æœ‰ç‚¹ bullshtï¼‰ï¼š&lt;/p>
&lt;div id="outline-container-headline-5" class="outline-3">
&lt;h3 id="headline-5">
Modalka
&lt;/h3>
&lt;div id="outline-text-headline-5" class="outline-text-3">
&lt;p>
ä¸ºäº†å°æ‹‡æŒ‡çš„å¥åº·ï¼Œé¿å…å›  Control é”®æŒ‰å¤ªå¤šè€Œæ‰¿å—ä¸ä½ï¼ˆé›¾ï¼‰ï¼Œä¸€ä¸ª modal editing è¿˜æ˜¯ç›¸å½“æœ‰å¿…è¦çš„ã€‚æ‰€è°“ modal editingï¼Œå…¶å®å°±æ˜¯ç»™â€œç¼–è¾‘â€è¿™ä¸ªæ“ä½œåˆ†æ¨¡å¼ï¼Œåƒ Vim æœ‰ Normal å’Œ Insertã€‚&lt;/p>
&lt;p>
é€‰æ‹© &lt;a href="https://github.com/mrkkrp/modalka">Modalka&lt;/a> çš„åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œå› ä¸ºå®ƒä¾µå…¥æ€§æ²¡æœ‰åƒ Evil æˆ–è€… god-mode é‚£æ ·å¼ºï¼Œç•™æœ‰äº†æ›´å¤šçš„è‡ªå®šä¹‰ç©ºé—´ã€‚åŸºæœ¬ä»¿ç…§ç€ä½œè€…æœ¬äººçš„é…ç½®ï¼Œæ˜ å°„çš„åŸºæœ¬æ˜¯ Emacs çš„åŸç”Ÿé”®ä½ï¼Œä½†æ˜¯å°†å¸¸ç”¨çš„ &lt;code>x&lt;/code> å’Œ &lt;code>c&lt;/code> é”®æ˜ å°„ä¸ºäº†åƒ god-mode é‚£æ ·çš„ &lt;code>C-x&lt;/code> å‰ç¼€è°ƒç”¨ã€‚&lt;/p>
&lt;p>
å› ä¸ºæˆ‘è‡ªå·± LWin é”®ç”¨çš„å¹¶ä¸å¤šï¼Œæ‰€ä»¥ç›´æ¥å°†å®ƒæ˜ å°„ä¸º &lt;code>&amp;lt;menu&amp;gt;&lt;/code> é”®å¹¶ç”¨æ¥åˆ‡æ¢ modalka-modeï¼ŒåŒæ—¶æ˜ å°„ &lt;code>&amp;lt;insert&amp;gt;&lt;/code> ä½œä¸º fallback æŒ‰é”®ï¼Œè¿™æ ·å°±èƒ½é€šè¿‡å·¦æ‰‹æ‰‹æŒæŒ‰å‹æ¥å¿«é€Ÿåˆ‡æ¢äº†ã€‚&lt;/p>
&lt;p>
P.S. ä¸è¿‡å…¶å®å‘ç°è‡ªå·±å¥½åƒ modal æ¨¡å¼ç”¨çš„ä¸æ˜¯å¾ˆé¢‘ç¹ï¼ŒControl é”®æŒ‰çš„ä¾ç„¶â€œæ¬¢å¿«â€ã€‚å¯èƒ½ç¡®å®ä¹ æƒ¯äº†ç»Ÿä¸€å¿«æ·é”®çš„æ–¹å¼ï¼ˆï¼Ÿï¼‰ï¼Œä¸è¿‡ä¸ºäº†å°æ‹‡æŒ‡ï¼Œè¿˜æ˜¯å¤šåˆ‡åˆ‡ä¹ æƒ¯ä¹ æƒ¯å¥½äº†ã€‚&lt;/p>
&lt;/div>
&lt;/div>
&lt;div id="outline-container-headline-6" class="outline-3">
&lt;h3 id="headline-6">
Workspace
&lt;/h3>
&lt;div id="outline-text-headline-6" class="outline-text-3">
&lt;p>
å·¥ä½œåŒºåˆ™ç›¸å½“æ¥è¿‘ i3 è¿™æ ·çš„é…ç½®ï¼Œä¸è¿‡å› ä¸ºä¸»åŠ›ç³»ç»Ÿæ˜¯ Windowsï¼ˆä¸è¦é—®ä¸ºä»€ä¹ˆï¼Œæˆ‘ä¹Ÿå¾ˆæƒ³æ¢ï¼Œä½†æ˜¯ä¸‡æ¶é˜¿é‡Œéƒï¼‰ï¼Œå› æ­¤æ²¡åŠæ³•åˆ©ç”¨ Win é”®åˆ‡æ¢ï¼Œæ‰€ä»¥è¿˜æ˜¯ç”¨çš„å¿«ä»¶é”®åˆ‡æ¢ã€‚&lt;/p>
&lt;p>
ä½¿ç”¨äº† Emacs é»˜è®¤çš„ &lt;code>tab-bar-mode&lt;/code> æ¥ç®¡ç†å·¥ä½œåŒºï¼Œé€šè¿‡ &lt;code>C-m 1&lt;/code> è¿™æ ·çš„å¿«æ·é”®åˆ‡æ¢ã€‚è€Œçª—å£åˆ™ä½¿ç”¨ &lt;code>winum&lt;/code> æ’ä»¶é…åˆ &lt;code>M-1&lt;/code> è¿™æ ·çš„å¿«æ·é”®å¿«é€Ÿåˆ‡æ¢ã€‚&lt;/p>
&lt;p>
è¿™ä¹ˆé€‰æ‹©ä¸»è¦æ˜¯æ„Ÿè§‰æ—¥å¸¸ä¸­åˆ‡æ¢å·¥ä½œåŒºçš„é¢‘ç‡ï¼Œç›¸å¯¹ä¸åˆ‡æ¢çª—å£æ¥è¯´è¦å°‘ä¸€ç‚¹ï¼ˆè™½è¯´å¦‚æ­¤ï¼Œæˆ‘è¿˜æ˜¯å¾ˆæƒ³åƒ i3 é‚£æ ·çš„å…¨éƒ½è¦ï¼‰ã€‚&lt;/p>
&lt;/div>
&lt;/div>
&lt;div id="outline-container-headline-7" class="outline-3">
&lt;h3 id="headline-7">
Region
&lt;/h3>
&lt;div id="outline-text-headline-7" class="outline-text-3">
&lt;p>
æ—¥å¸¸æ”¹ä»£ç çš„æ—¶å€™ï¼Œæœ€é‡è¦çš„å…¶å®å°±æ˜¯ region çš„æ“æ§ï¼Œå¦‚ Vim ç»å¸¸è¢«ä½¿ç”¨çš„ &lt;code>cw&lt;/code> å‘½ä»¤ã€‚å› æ­¤é€‰å®šäº†ä½¿ç”¨ &lt;a href="https://github.com/magnars/expand-region.el">expand-region.el&lt;/a> æ¥å¿«é€Ÿé€‰æ‹©åŒºåŸŸï¼Œè¿™éƒ¨åˆ†å€Ÿé‰´äº† &lt;a href="https://github.com/meow-edit/meow">Meow&lt;/a> çš„è®¾è®¡å“²å­¦ï¼Œå…ˆé€‰å®šåŒºåŸŸï¼Œå†å†³å®šåŠ¨ä½œã€‚å½“ç„¶ä¹Ÿä» Meow é‚£â€œæŠ„â€æ¥äº† &lt;code>meow-inner-of-thing&lt;/code> ä½œä¸ºå¤‡é€‰ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Vim çš„é€»è¾‘æ˜¯ï¼Œæˆ‘æƒ³è¿›è¡Œä¸€ä¸ªæ›¿æ¢çš„æ“ä½œï¼Œä½œç”¨åœ¨ä¸€ä¸ªå•è¯ä¸Šï¼›&lt;/p>
&lt;p>
Meow çš„é€»è¾‘åˆ™æ˜¯ï¼Œæˆ‘é€‰å®šäº†ä¸€ä¸ªå•è¯ï¼Œå¯¹å®ƒè¿›è¡Œæ›¿æ¢çš„æ“ä½œï¼›&lt;/p>
&lt;p>
è¿™ä¸¤ç§é€»è¾‘æ²¡æœ‰å¯¹é”™ï¼Œåªæœ‰é’ˆå¯¹è‡ªå·±è€Œè¨€æ˜¯å¦ä¹ æƒ¯ï¼Œæˆ‘å°±æ›´åå‘äº Meow çš„é€»è¾‘ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>
å½“ç„¶ä¹Ÿç¼åˆäº† &lt;a href="https://github.com/oantolin/embark">Embark&lt;/a> æ¥è¿›è¡Œæ“ä½œï¼Œä½†æ˜¯å®é™…ä¸Šç›®å‰ç”¨çš„å¹¶ä¸å¤šï¼Œåªæ˜¯æœç´¢ç¬¦å·çš„æ—¶å€™ä»£æ›¿ Vim çš„ &lt;code>*/#&lt;/code> è¿™æ ·çš„å‘½ä»¤ã€‚åœ¨è€ƒè™‘æ˜¯å¦è¦å’”åš“æ‰ hhhhã€‚&lt;/p>
&lt;/div>
&lt;/div>
&lt;div id="outline-container-headline-8" class="outline-3">
&lt;h3 id="headline-8">
Jump
&lt;/h3>
&lt;div id="outline-text-headline-8" class="outline-text-3">
&lt;p>
å¤§å®¶å¥½åƒéƒ½å¾ˆå–œæ¬¢ç”¨ &lt;a href="https://github.com/abo-abo/avy">avy&lt;/a> æ¥è·³è½¬ï¼Œç»è¿‡ä¸€äº›å°ä»£ç æµè§ˆçš„ç»éªŒï¼Œç›®å‰æˆ‘ä¹ æƒ¯çš„è·³è½¬æ–¹å¼æœ‰ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>C-;&lt;/code> è·³è½¬åˆ°åŒä¸€è¡Œï¼ˆæˆ–è€…ä¸Šä¸‹ä¸¤è¡Œï¼‰çš„ word ä¸Š&lt;/li>
&lt;li>&lt;code>C-&amp;#39;&lt;/code> ä»»æ„å•è¯è·³è½¬&lt;/li>
&lt;li>&lt;code>C-u X C-n/p&lt;/code> é…åˆç›¸å¯¹è¡Œå·å¿«é€Ÿè·³è½¬ï¼ˆå…¶å®ç›®å‰è¿™ä¸ªç”¨çš„æ›´å¤šï¼Œå¯èƒ½æ˜¯ç›®å‰å¯¹â€œè¡Œâ€çš„æ“ä½œæ›´å¤šï¼‰&lt;/li>
&lt;li>&lt;code>C-j d/r&lt;/code> è·³è½¬ + è½¬åˆ°å®šä¹‰æˆ–å¼•ç”¨ï¼Œæ¥è‡ª &lt;a href="https://github.com/MaskRay/Config">MaskRay&lt;/a> å¤§ä½¬çš„é…ç½®&lt;/li>
&lt;/ul>
&lt;p>é™¤æ­¤ä¹‹å¤–ä¹Ÿé…ç½®äº†å¾ˆå¤šå…¶ä»–çš„è·³è½¬æ–¹å¼ï¼Œä½†æ˜¯æ„Ÿè§‰éƒ½ä¸æ€ä¹ˆç”¨çš„æ ·å­ï¼Œä¸»è¦æ˜¯æˆ‘ç›®å‰è¿˜æ²¡æœ‰å®Œå…¨æƒ³å¥½çœŸæ­£é«˜æ•ˆçš„å®šä½æ–¹å¼ï¼Œæ˜¯ avy è¿™æ ·æ›´å¿«ï¼Œäº¦æˆ–æ˜¯ Emacs æœ¬èº«çš„æ“ä½œå°±è¶³å¤Ÿäº†ï¼Œè¿˜æ˜¯â€œç»„åˆæ‹³â€æ›´ä¸ºé€‚åº”ï¼Ÿ&lt;/p>
&lt;p>
ç°åœ¨è€Œè¨€ï¼Œæˆ‘å°½é‡éµå¾ª &lt;strong>Jump more, move less&lt;/strong> çš„åŸåˆ™ï¼Œå°½é‡åœ°ä½¿ç”¨è·³è½¬ä»£æ›¿ &lt;code>C-f&lt;/code> ç­‰æ“ä½œï¼Œå½“ç„¶åœ¨æ­£å¸¸ç¼–è¾‘ä¸­ä¸€äº›å°é”™è¯¯çš„ä¿®æ­£è¿˜æ˜¯ç¦»ä¸å¼€ &lt;code>C-f&lt;/code> ç­‰ã€‚&lt;/p>
&lt;/div>
&lt;/div>
&lt;div id="outline-container-headline-9" class="outline-3">
&lt;h3 id="headline-9">
&lt;span class="todo">TODO&lt;/span>
Next
&lt;/h3>
&lt;div id="outline-text-headline-9" class="outline-text-3">
&lt;p>
ç›®å‰æ¯”è¾ƒçº ç»“è¦ä¸è¦æŠŠ Meow æ›¿æ¢æ‰ Modalkaï¼Œå› ä¸ºå®ƒçš„è®¾è®¡æ€æƒ³ç¡®å®æ¯”è¾ƒå¯¹æˆ‘ï¼Œä½†æ˜¯åˆæ„Ÿè§‰å®é™…ä¸Šæˆ‘åªæ˜¯å–œæ¬¢å®ƒçš„é€‰æ‹©æ¨¡å¼ï¼Œæœ‰äº† &lt;code>expand-region.el&lt;/code> ä¹‹åä¼¼ä¹ä¹Ÿä¸é‚£ä¹ˆå¿…éœ€äº†ã€‚æˆ‘ä¹ŸæŠŠ Vim çš„ &lt;code>c&lt;/code> é”®æŒªåˆ°äº† Modalka ä¸Šï¼Œè¿™æ ·æ“ä½œåŒºåŸŸå°±æ›´ç®€å•äº†ã€‚&lt;/p>
&lt;p>
è¿˜æœ‰éœ€è¦é…Œå®šçš„å°±æ˜¯æ‰€è°“çš„ Ergoï¼Œå³äººä½“å·¥ç¨‹å­¦ï¼Œä¹‹å‰å°è¯•äº†ä¸€ä¸‹ &lt;a href="https://github.com/jyp/boon">Boon&lt;/a> å‘ç°å¥½åƒæ²¡æœ‰å¿…è¦ä¸ºäº†çœä¸€ç‚¹çš„æ‰‹æŒ‡æŒªåŠ¨è·ç¦»è€Œæ”¾å¼ƒå…»æˆçš„ä¹ æƒ¯ã€‚&lt;/p>
&lt;p>
P.S. èµ°äº†ä¸€é Boon çš„ Tutor æ‰æ˜ç™½ï¼ŒåŸæ¥æ‰‹æŒ‡å°½é‡ä¸ç§»åŠ¨ + å·¦å³æŒ‰é”®åˆ†é…å‡è¡¡ï¼Œå°±å«åšäººä½“å·¥ç¨‹å­¦é”®ä½äº†ã€‚ã€‚æ„Ÿè§‰å¯ä»¥è¯•è¯• Dvorak/Colemark/Workman äº†çš„è¯´ã€‚&lt;/p>
&lt;p>
å¦å¤– IDE å¸¸ç”¨çš„å‘å‰å‘åè·³è½¬è¿˜æš‚æ—¶æ²¡æœ‰å»å¼„ï¼Œå› ä¸ºåƒ &lt;code>better-jumper&lt;/code> è¿™æ ·çš„æ’ä»¶éƒ½éœ€è¦è‡ªå·±æ‰‹åŠ¨ mark è·³è·ƒç‚¹æ‰è¡Œï¼Œæƒ³æƒ³è¿˜æ˜¯æœ‰ä¸€å®šå·¥ä½œé‡çš„ã€‚ä¾ç„¶è¿˜åœ¨ç£¨åˆæœŸï¼ˆã€‚&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div id="outline-container-headline-10" class="outline-2">
&lt;h2 id="headline-10">
Devil
&lt;/h2>
&lt;div id="outline-text-headline-10" class="outline-text-2">
&lt;p>
æ¥è‡ª &lt;a href="http://web.archive.org/web/20180602132306/https://plus.google.com/+LinusTorvalds/posts/iySKQGtkmtb">Linus Torvalds&lt;/a>ï¼š&lt;/p>
&lt;blockquote>
&lt;p>So for the other three people out there using &amp;#34;uEmacs/PK&amp;#34; (not to be confused with real emacs, which is the tool of the devil), you can now get a shiny new version of the same old cruddy editor, but now it actually edits UTF8.&lt;/p>
&lt;/blockquote>
&lt;p>
æˆ‘å°è¯•ç¼–è¯‘äº†ä¸€ä»½ &lt;a href="https://github.com/torvalds/uemacs">torvalds/uemacs&lt;/a> ç©ç©ï¼Œå‘ç°å®ƒçœŸçš„å¾ˆçº¯ç²¹ï¼ˆçº¯ç²¹åˆ°æŒ‰é”®ç»‘å®šå…¨éƒ½æ˜¯ç¡¬ç¼–ç åœ¨ C æ–‡ä»¶é‡Œçš„ï¼‰ï¼Œè€Œä¸”è´¯å½»ç€ä¸Šè¿°â€œåªåšä¸€ä»¶äº‹â€çš„ UNIX å“²å­¦ã€‚ä¹Ÿéš¾æ€ª Linus ä¼šå¦‚æ­¤è¯„ä»· Emacsï¼ˆã€‚&lt;/p>
&lt;/div>
&lt;/div>
&lt;div id="outline-container-headline-11" class="outline-2">
&lt;h2 id="headline-11">
æ··ä¹±ä¸­ç«‹
&lt;/h2>
&lt;div id="outline-text-headline-11" class="outline-text-2">
&lt;p>
é…ç½®ä¹…äº†ä¹‹åå°±æœ‰ä¸€ç‚¹æ„Ÿå—æ˜¯ï¼Œå½“èƒ½å®Œå…¨è‡ªå®šä¹‰è‡ªå·±çš„ workflow æ—¶ï¼Œæˆ‘å‘ç°é€‰æ‹©çªç„¶å¤ªå¤šäº†ï¼Œè‡ªå·±ä¼¼ä¹æ— æ³•å®šå¤ºåˆ°åº•å“ªç§æ‰æ˜¯æ›´å¥½çš„ï¼Œå¯¼è‡´è‡ªå·±çš„é…ç½®å­˜åœ¨å„ç§â€œæ··ä¹±â€ï¼Œå¾ˆå¤šåŠŸèƒ½ç›¸äº’é‡å ï¼Œç”šè‡³æ˜¯ç”¨ä¸ä¸Šä½†æ„Ÿè§‰åˆèƒ½æå‡æ•ˆç‡ã€‚&lt;/p>
&lt;p>
ä¹Ÿå°±æ˜¯æœ‰äº†ä¸€ç‚¹æ‰€è°“çš„ Premature Optimization çš„æ„Ÿè§‰ï¼Œæ˜æ˜åº”è¯¥æ˜¯æå‡æ•ˆç‡çš„ï¼Œå¯æ˜¯æœ€åå´è¢«æŸç¼šäº†ã€‚æ€æ¥æƒ³å»è¿˜æ˜¯è§‰å¾—ï¼Œæ–¹æ³•æ˜¯æ‹¿æ¥è§£å†³é—®é¢˜çš„ï¼Œè¿˜æ˜¯å›å½’æˆ‘é‡åˆ°çš„é—®é¢˜æœ¬èº«ï¼Œå†è¿›è¡Œå®¢åˆ¶åŒ–å§ã€‚&lt;/p>
&lt;p>
å¯èƒ½æ˜¯ Emacs å¤©ç„¶ç‹¬æœ‰çš„æ··ä¹±ä¸­ç«‹ï¼Œå®ƒå¯ä»¥æ˜¯ä¸ºä½ æå‡æ•ˆç‡çš„å–„è‰¯å¤©ä½¿ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»™ä½ æ£ä¹±è®©ä½ åè€Œè¢«æŸç¼šä½çš„é‚ªæ¶é­”é¬¼ã€‚&lt;/p>
&lt;p>
ç»™è‡ªå·±çš„è°¨è®°ï¼š &lt;strong>å·¥å…·å§‹ç»ˆæ˜¯æ‹¿æ¥è§£å†³é—®é¢˜ï¼Œè€ŒéæŠ˜ç£¨è‡ªå·±çš„&lt;/strong> ã€‚&lt;/p>
&lt;p>
&lt;em>May the Emacs be with you.&lt;/em>&lt;/p>
&lt;/div>
&lt;/div></description></item><item><title>æµ…å…¥ x86 å†…å­˜åº</title><link>https://collect.fn.pub/2022/12-17-memory-order-in-x86/</link><pubDate>Sat, 17 Dec 2022 17:10:42 +0800</pubDate><guid>https://collect.fn.pub/2022/12-17-memory-order-in-x86/</guid><description>&lt;pre tabindex="0">&lt;code class="language-log" data-lang="log">[WARN] Using deprecated method `memory-order&amp;#39;, it might be removed in the future.
&lt;/code>&lt;/pre>&lt;h2 id="å†…å­˜åºmemory-order">å†…å­˜åºï¼ˆMemory Orderï¼‰&lt;/h2>
&lt;p>åœ¨ x86 ä¸­ï¼Œå†…å­˜å±éšœé€šå¸¸æ˜¯ä¸éœ€è¦çš„ï¼Œå› ä¸º x86 æ˜¯æ¯”è¾ƒä¸¥æ ¼çš„ TSOï¼ˆä¸å®Œå…¨ï¼Œå› ä¸ºå§‹ç»ˆæ²¡æœ‰â€œå®˜å®£â€ï¼Œä½†æ˜¯æŒ‰ç…§å®šä¹‰æ¥è¯´æ¯”è¾ƒæ¥è¿‘ï¼Œè€Œä¸”ä¸åŒçš„å‚å•†å¦‚ AMD/Intel ä¹‹é—´çš„å®ç°ä¹Ÿå­˜åœ¨ç•¥å¾®å·®åˆ«ï¼‰ã€‚&lt;/p>
&lt;p>ç™¾åº¦æ‰¾åˆ°äº†ä¸€ä»½ &lt;a href="https://www.cis.upenn.edu/~devietti/classes/cis601-spring2016/sc_tso.pdf">sc_tso.pdf&lt;/a> è®²è¿°äº† TSO çš„ä¸€äº›ç‰¹ç‚¹ï¼Œå…¶ä¸­åŒ…æ‹¬ç¨‹åºé¡ºåºï¼ˆprogram orderï¼‰ä¸å†…å­˜åºï¼ˆmemory orderï¼‰ä¹‹é—´çš„å…³ç³»ï¼š&lt;/p>
&lt;blockquote>
&lt;ol>
&lt;li>Whether they are to the same or different addresses (i.e., a=b or aâ‰ b).If L(a) &amp;lt;p L(b) â‡’ L(a) &amp;lt;m L(b) /* Loadâ†’Load */If L(a) &amp;lt;p S(b) â‡’ L(a) &amp;lt;m S(b) /* Loadâ†’Store */If S(a) &amp;lt;p S(b) â‡’ S(a) &amp;lt;m S(b) /* Storeâ†’Store */&lt;del>If S(a) &amp;lt;p L(b) â‡’ S(a) &amp;lt;m L(b)&lt;/del> /* Storeâ†’Load */: Enable FIFO write buffer&lt;/li>
&lt;li>When to the same address, every load gets its value from the last store before it.
If S(a) &amp;lt;p L(a) â‡’ S(a) &amp;lt;m L(a) /* Storeâ†’Load */&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>å…¶ä¸­ &lt;code>&amp;lt;p&lt;/code> è¡¨ç¤ºçš„æ˜¯ç¨‹åºé¡ºåºä¸‹çš„å…ˆåå…³ç³»ï¼Œè€Œ &lt;code>&amp;lt;m&lt;/code> åˆ™æ˜¯å†…å­˜é¡ºåºä¸‹çš„å…ˆåå…³ç³»ã€‚&lt;strong>æ³¨æ„è¿™é‡Œä¸è€ƒè™‘ç¼–è¯‘å™¨è¿›è¡Œè¿‡çš„æŒ‡ä»¤é‡æ’ï¼Œè¿™é‡Œçš„ç¨‹åºé¡ºåºä¹Ÿæ˜¯ç¼–è¯‘å®Œåçš„æ±‡ç¼–é¡ºåº&lt;/strong>ã€‚&lt;/p>
&lt;p>å†…å­˜åºå…¶å®ä¸ä¸€å®šè¦å®Œå…¨å†™å›åˆ°å†…å­˜æ‰ç®—ï¼Œåªè¦å…¶ä»– CPU èƒ½çœ‹åˆ°æœ€ç»ˆæ›´æ”¹å°±è¡Œäº†ï¼ˆglobally visibleï¼‰ï¼Œä¾‹å¦‚æœ€å¸¸è§çš„ Store-Loadï¼Œå‡å¦‚ Store(a, 100) æ‰§è¡Œå®Œåï¼Œé‚£ä¹ˆå…¶ä»–ä»»æ„çš„æ ¸å¿ƒåœ¨æ‰§è¡Œ Load(a) æ—¶ç»“æœéƒ½å¿…é¡»ä¿è¯ä¸º 100ï¼›ä½†æ˜¯è¿™ä¸ä¸€å®šæ„å‘³ç€å†…å­˜ä¸­çš„ a å°±ä¸€å®šæ˜¯ 100ï¼Œæœ‰å¯èƒ½å®ƒè¿˜åªæ˜¯åœ¨ L3 Cache ä¸­ã€‚&lt;/p>
&lt;p>ä¸Šé¢çš„å¼•ç”¨å¤„æˆ‘è¿˜æ˜¯ç¨å¾®ä¿®æ”¹äº†ä¸€ç‚¹ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼›å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæ‰€æœ‰çš„ Load/Storeï¼Œä¸‰ç§ Load-Loadã€Load-Storeã€Store-Store éƒ½æ˜¯ SC çš„ï¼Œå³å†…å­˜åºå°±æ˜¯ç¨‹åºåºã€‚ä½†æ˜¯ä¹‹æ‰€ä»¥æˆ‘ä»¬è¯´ TSO è¦å¼±äº SCï¼Œæ˜¯å› ä¸ºå¯¹äº Store-Load è¿™æ ·çš„æ“ä½œå¹¶æ²¡æœ‰è¿™ä¹ˆä¸¥æ ¼ï¼ŒStore-Load åªæœ‰åœ¨å½“è¯»å†™åŒä¸€ä¸ªåœ°å€ï¼ˆåŒä¸€ç‰‡å†…å­˜æ—¶ï¼‰æ‰æ˜¯æˆç«‹çš„ï¼›è¯»å†™ä¸åŒå†…å­˜æ—¶ Store-Load ä¸‹ç¨‹åºåºæ˜¯ä¸èƒ½ç­‰ä»·äºå†…å­˜åºçš„ã€‚&lt;/p>
&lt;p>èƒ½ä½œè¯è¿™ä¸€ç‚¹çš„è¿˜æœ‰ &lt;a href="https://software.intel.com/content/www/us/en/develop/articles/intel-sdm.html">Intel SDM&lt;/a> Volume 3 8.2.2 éƒ¨åˆ†ï¼Œè¿™é‡Œä¹Ÿæ‘˜å½•äº†ä¸€ä¸‹ï¼š&lt;/p>
&lt;blockquote>
&lt;ol>
&lt;li>Reads are not reordered with other reads.&lt;/li>
&lt;li>Writes are not reordered with older reads.&lt;/li>
&lt;li>Writes to memory are not reordered with other writes, with the following exceptions:
&lt;ul>
&lt;li>streaming stores (writes) executed with the non-temporal move instructions (MOVNTI, MOVNTQ, MOVNTDQ, MOVNTPS, and MOVNTPD); and&lt;/li>
&lt;li>string operations (see Section 8.2.4.1).&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>No write to memory may be reordered with an execution of the CLFLUSH instruction; a write may be reordered with an execution of the CLFLUSHOPT instruction that flushes a cache line other than the one being written.1 Executions of the CLFLUSH instruction are not reordered with each other. Executions of CLFLUSHOPT that access different cache lines may be reordered with each other. An execution of CLFLUSHOPT may be reordered with an execution of CLFLUSH that accesses a different cache line.&lt;/li>
&lt;li>Reads may be reordered with older writes to different locations but not with older writes to the same location.&lt;/li>
&lt;li>Reads or writes cannot be reordered with I/O instructions, locked instructions, or serializing instructions.&lt;/li>
&lt;li>Reads cannot pass earlier LFENCE and MFENCE instructions.&lt;/li>
&lt;li>Writes and executions of CLFLUSH and CLFLUSHOPT cannot pass earlier LFENCE, SFENCE, and MFENCE instructions.&lt;/li>
&lt;li>LFENCE instructions cannot pass earlier reads.&lt;/li>
&lt;li>SFENCE instructions cannot pass earlier writes or executions of CLFLUSH and CLFLUSHOPT.&lt;/li>
&lt;li>MFENCE instructions cannot pass earlier reads, writes, or executions of CLFLUSH and CLFLUSHOPT.&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„å°±æ˜¯ä¸Šé¢çš„ç¬¬ 1ã€2ã€3ã€5 ç‚¹ã€‚ç¿»è¯‘ä¸‹æ¥å°±æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>1. Load-Load ä¸‹å†…å­˜åºç­‰äºç¨‹åºåºï¼ˆä¸ä¼šè¢«é‡æ’ï¼‰&lt;/li>
&lt;li>2. Load-Store ä¸‹å†…å­˜åºç­‰äºç¨‹åºåºï¼Œæ³¨æ„è¿™é‡Œå†™çš„æ˜¯ older readsï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰ Store æŒ‡ä»¤ï¼ˆ&lt;code>MOV&lt;/code> ç­‰ï¼‰ä¹‹å‰çš„ Load æŒ‡ä»¤éƒ½ä¸ä¼šè¢«é‡æ–°æ’åº&lt;/li>
&lt;li>3. Store-Store ä¸‹å†…å­˜åºç­‰äºç¨‹åºåºï¼Œä¾‹å¤–æƒ…å†µæ˜¯ non-temporal å’Œ rep mov ä¹‹ç±»çš„æŒ‡ä»¤ï¼ˆåé¢ä¼šæåˆ°ï¼Œåœ¨å†™ä¸€èˆ¬ä»£ç æ—¶ä¸ä¼šå¤ªæ¥è§¦åˆ°ï¼‰&lt;/li>
&lt;li>5. Store-Load ä¸‹åªæœ‰å½“è¯»å†™çš„éƒ½æ˜¯åŒæ ·çš„åœ°å€æ—¶å†…å­˜åºæ‰ç­‰äºç¨‹åºåºï¼Œå¦åˆ™å¯¹äºä¸åŒçš„åœ°å€çš„è¯»å†™ä¾ç„¶ä¼šå­˜åœ¨é‡æ’&lt;/li>
&lt;/ul>
&lt;p>åˆ°è¿™é‡Œåº”è¯¥å¤§æ¦‚å°±äº†è§£äº†ä¸ºä½•è¯´ x86 æ¶æ„æ™®ééƒ½æ˜¯ TSOï¼Œä»¥åŠä¸ºä½• TSO è¦å¼±äº SCã€‚&lt;/p>
&lt;h2 id="å¤šæ ¸å¿ƒ">å¤šæ ¸å¿ƒ&lt;/h2>
&lt;p>&lt;strong>æ³¨æ„&lt;/strong>ä¸Šè¿°ä¾‹å­éƒ½åªåœ¨å•æ ¸å¿ƒä¸­ç”Ÿæ•ˆï¼ŒåŒ…æ‹¬ TSO è¿™äº›ï¼ˆå†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™å¥½åƒæ²¡è€ƒè™‘åˆ°å•/å¤šæ ¸å¿ƒé—®é¢˜ï¼Œå¯èƒ½è¦å›ç‚‰é‡é€ äº† FIXMEï¼‰ã€‚å¯¹äºå¤šæ ¸å¿ƒç³»ç»Ÿï¼ˆmultiple-processorï¼‰ï¼ŒSDM Volume 3 8.2.2 åŒæ ·ä¹Ÿå®šä¹‰äº†ï¼š&lt;/p>
&lt;blockquote>
&lt;ol>
&lt;li>Individual processors use the same ordering principles as in a single-processor system.&lt;/li>
&lt;li>Writes by a single processor are observed in the same order by all processors.&lt;/li>
&lt;li>Writes from an individual processor are NOT ordered with respect to the writes from other processors.&lt;/li>
&lt;li>Memory ordering obeys causality (memory ordering respects transitive visibility).&lt;/li>
&lt;li>Any two stores are seen in a consistent order by processors other than those performing the stores&lt;/li>
&lt;li>Locked instructions have a total order.&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>é‡ç‚¹å°±æ˜¯ï¼Œåœ¨å¤šæ ¸å¿ƒçš„æƒ…å†µä¸‹ï¼Œå•æ ¸å¿ƒçš„å†™å…¥é¡ºåºå¯ä»¥ä¿æŒä¸å˜ï¼Œä½†æ˜¯å¾ˆå¯èƒ½ä¼šç©¿æ’è¿›å…¶ä»–æ ¸å¿ƒçš„å†™æ“ä½œã€‚SDM ä¸Šé™„å¸¦äº†ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ¥è§£é‡Šè¿™ä¸€è¡Œä¸ºï¼Œè€ƒè™‘ä¸‰ä¸ªæ ¸å¿ƒéƒ½åœ¨åŒæ—¶å†™å…¥æ•°æ®ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt; Writes from individual processors:
Processor#1 Processor#2 Processor#3
Write A.1 Write A.2 Write A.3
Write B.1 Write B.2 Write B.3
Write C.1 Write C.2 Write C.3
&amp;gt; Actual writes (one of the example) in memory:
Write A.1
Write B.1
Write A.2
Write A.3
Write C.1
Write B.2
Write C.2
Write B.3
Write C.3
&lt;/code>&lt;/pre>&lt;p>P.S. ç¬¬å››ç‚¹çš„â€œå› æœå¾‹â€å¯èƒ½ä¸€å¼€å§‹è®©äººè§‰å¾—æœ‰ç‚¹æ‘¸ä¸ç€å¤´è„‘ï¼Œå¯ä»¥å‚è€ƒ &lt;a href="https://stackoverflow.com/a/27374794">Stack Overflow&lt;/a> çš„ä¾‹å­æ¥äº†è§£ï¼Œå®é™…ä¸Šå°±æ˜¯ä¿è¯å¦‚æœå•ä¸ªå˜é‡å†™å…¥ä¸”èƒ½è¢«æ­£ç¡®è§‚æµ‹åˆ°ï¼Œé‚£ä¹ˆå‰é¢æ‰€æœ‰çš„å˜é‡å†™å…¥éƒ½åº”è¯¥å¯ä»¥è¢«è§‚æµ‹åˆ°ã€‚ä¸ªäººç†è§£ x86 åœ¨å¤šæ ¸å¿ƒçš„å†…å­˜åºä¸Šç›¸å¯¹æ¯”è¾ƒâ€œéš¾é¢„æµ‹â€ï¼Œå†…å­˜åºä¾èµ–äºè§‚æµ‹åˆ°çš„å€¼ï¼Œä¹Ÿå°±æ˜¯åªæœ‰åœ¨â€œçœ‹â€åˆ°äº†å®é™…çš„å€¼ä¹‹åï¼Œæ‰èƒ½çŸ¥é“å“ªäº›å˜é‡è¢«æ­£ç¡®åœ°å†™å…¥äº†ã€‚&lt;/p>
&lt;h2 id="ä¸€ä¸ªæ —å­">ä¸€ä¸ªæ —å­&lt;/h2>
&lt;p>ä¸€ä¸ªæˆ‘è§‰å¾—å¾ˆæœ‰â€œæ„æ€â€çš„ä¾‹å­ï¼Œæ¥æºä¸€ä¸ªçŸ¥ä¹æ–‡ç« ï¼Œä»‹ç»&lt;a href="https://zhuanlan.zhihu.com/p/454564295">å†…å­˜å±éšœ&lt;/a>æ‰€ç”¨çš„ï¼ŒåŸæ–‡ä»£ç æœ‰ç‚¹ä¹±ï¼Œè¿™é‡Œé‡æ–°æ ¼å¼åŒ–å¹¶ç¨å¾®ç²¾ç®€äº†ä¸€ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#define _GNU_SOURCE
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sched.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;pthread.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;assert.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">volatile&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="n">pthread_barrier_t&lt;/span> &lt;span class="n">barrier_start&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="n">pthread_barrier_t&lt;/span> &lt;span class="n">barrier_end&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">void&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="nf">thread1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pthread_barrier_wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">barrier_start&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// run1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">r1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pthread_barrier_wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">barrier_end&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">void&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="nf">thread2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pthread_barrier_wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">barrier_start&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// run2
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">r2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pthread_barrier_wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">barrier_end&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pthread_barrier_init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">barrier_start&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pthread_barrier_init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">barrier_end&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pthread_t&lt;/span> &lt;span class="n">t1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pthread_t&lt;/span> &lt;span class="n">t2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pthread_create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">t1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">thread1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pthread_create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">t2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">thread2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cpu_set_t&lt;/span> &lt;span class="n">cs&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">CPU_ZERO&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">cs&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">CPU_SET&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">cs&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pthread_setaffinity_np&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cs&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">cs&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">CPU_ZERO&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">cs&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">CPU_SET&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">cs&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pthread_setaffinity_np&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cs&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">cs&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// start()
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">r1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">r2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pthread_barrier_wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">barrier_start&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pthread_barrier_wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">barrier_end&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// end()
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">r1&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">r2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// gcc xxx.c -O2 -pthread &amp;amp;&amp;amp; ./a.out
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ ¹æ®åŸä½œè€…é˜è¿°ï¼Œè¿™æ®µç¨‹åºå¿…å®šä¼šäº§ç”Ÿ &lt;code>end()&lt;/code> å¤„å¼•å‘çš„æ–­è¨€é”™è¯¯ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥å¯¹ç€ä¸Šé¢çš„å¤šæ ¸å¿ƒä¸‹çš„å†…å­˜æ¨¡å‹ç¨å¾®è§£é‡Šä¸€ä¸‹å§ï¼Œæ ¹æ®ä¸Šé¢çš„å®šä¹‰ï¼Œçº¿ç¨‹ t1 å’Œçº¿ç¨‹ t2 åŒæ—¶å†™å…¥å˜é‡ &lt;code>x&lt;/code> ä¸ &lt;code>y&lt;/code>ï¼Œé‚£ä¹ˆçœŸå®çš„å†™å…¥é¡ºåºæœ‰å¯èƒ½æ˜¯å…ˆå†™ &lt;code>x&lt;/code> æˆ–æ˜¯å…ˆå†™ &lt;code>y&lt;/code>ï¼›ä¸è¿‡é‡ç‚¹è¿˜æ˜¯â€œè¯»â€çš„é¡ºåºï¼ŒæŒ‰ç…§å‰æ–‡å…³äº Store-Load åºçš„è§£é‡Šï¼Œ&lt;code>r1&lt;/code> å’Œ &lt;code>r2&lt;/code> &lt;strong>ä¸ä¸€å®š&lt;/strong>ä¼šè¯»åˆ°å†™å…¥çš„å€¼ï¼ˆå› ä¸ºä¸æ˜¯åŒä¸€ä¸ªæ ¸å¿ƒ)ï¼Œx86 å†…å­˜æ¨¡å‹åªä¿è¯å‡è®¾çœŸå®å†…å­˜å†™å…¥é¡ºåºä¸º &lt;code>x = 1; y = 1&lt;/code>ï¼Œé‚£ä¹ˆå¦‚æœ &lt;code>r1&lt;/code> è¯»åˆ° &lt;code>y == 1&lt;/code>ï¼Œåˆ™ &lt;code>r2&lt;/code> å¿…å®šä¹Ÿèƒ½è¯»åˆ° &lt;code>x == 1&lt;/code>ã€‚&lt;/p>
&lt;p>å¦å¤–æŒ‰ç…§ SDM å®˜æ–¹çš„è¯´æ³•ï¼ˆä½äº Volume 3 8.2.3.4ï¼‰ï¼Œ&lt;/p>
&lt;blockquote>
&lt;p>At each processor, the load and the store are to different locations and hence may be reordered. Any interleaving of the operations is thus allowed.One such interleaving has the two loads occurring before the two stores. This would result in each load returning value 0.&lt;/p>
&lt;/blockquote>
&lt;p>ä¹Ÿå°±æ˜¯è¯´å¯¹äºä¸€ä¸ªæ ¸å¿ƒè€Œè¨€ï¼Œåªæœ‰åœ¨&lt;strong>è¯¥æ ¸å¿ƒ&lt;/strong>ä¸Šè¯»å†™åŒä¸€åœ°å€æ‰æ˜¯é¡ºåºçš„ï¼›å¦åˆ™å°±ç®—å¤šæ ¸å¿ƒéƒ½è¯»å†™åŒä¸€åœ°å€ï¼Œä¸­é—´éƒ½æœ‰å¯èƒ½å‘ç”Ÿä¹±åºã€‚è¿™ä¸¤ç§è§£é‡Šéƒ½æ˜¯è¡Œå¾—é€šçš„ã€‚&lt;/p>
&lt;p>è§£å†³æ–¹æ³•å¯ä»¥æ˜¯ä¸‹é¢æ‰€è¿°çš„å†…å­˜å±éšœï¼Œå³åœ¨å†™å…¥ &lt;code>x&lt;/code> æˆ– &lt;code>y&lt;/code> åå¼•å…¥å†…å­˜å±éšœï¼Œä¿è¯ä¸‹ä¸€æ¡è¯»æŒ‡ä»¤æ‰§è¡Œå‰å®Œæˆå†™å…¥ï¼Œå³ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// t1/run1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">__asm__&lt;/span> &lt;span class="nf">__volatile__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;mfence&amp;#34;&lt;/span> &lt;span class="o">:::&lt;/span> &lt;span class="s">&amp;#34;memory&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">r1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// t2/run2
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">__asm__&lt;/span> &lt;span class="nf">__volatile__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;mfence&amp;#34;&lt;/span> &lt;span class="o">:::&lt;/span> &lt;span class="s">&amp;#34;memory&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">r2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ ·ä¸€æ¥ï¼Œæ‰€æœ‰å¯èƒ½çš„è·¯å¾„éƒ½ä¸å†ä¼šäº§ç”Ÿ &lt;code>r1&lt;/code> å’Œ &lt;code>r2&lt;/code> åŒæ—¶ä¸ºé›¶çš„æƒ…å†µäº†ï¼š&lt;/p>
&lt;ol>
&lt;li>t1 æ‰§è¡Œåˆ° &lt;code>x = 1&lt;/code>ï¼Œt2 æ‰§è¡Œåˆ° &lt;code>mfence&lt;/code>ï¼Œé‚£ä¹ˆ t1 å¿…ç„¶èƒ½ä¿è¯ &lt;code>r1 = y = 1&lt;/code>ï¼Œå› ä¸º t2 ä½¿ç”¨äº† &lt;code>mfence&lt;/code> å¼ºåˆ¶ CPU æŒ‰ç…§ &lt;code>x = 1; r2 = x&lt;/code> çš„é¡ºåºæ‰§è¡Œï¼ˆå¦‚æœæ²¡æœ‰ &lt;code>mfence&lt;/code> å°±å¯èƒ½ä¼šå‡ºç° &lt;code>r2 = x; r1 = y; x = 1; y = 1&lt;/code> çš„å†…å­˜è¯»å†™é¡ºåºå‡ºç°ï¼‰&lt;/li>
&lt;li>t1 æ‰§è¡Œåˆ° &lt;code>mfence&lt;/code>ï¼Œt2 æ‰§è¡Œåˆ° &lt;code>y = 1&lt;/code>ï¼ŒåŒæ ·ï¼Œt2 å¿…ç„¶èƒ½ä¿è¯ &lt;code>r2 = x = 1&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>æ³¨æ„ &lt;code>x&lt;/code> ä¸ &lt;code>y&lt;/code> æ˜¯å¦èƒ½å¤Ÿè¢«è§‚æµ‹åˆ°ä¸æŒ‡ä»¤ä¹±åºæ²¡æœ‰å¤ªå¤§å…³ç³»ï¼Œå†…å­˜å±éšœåªä¿è¯è¯»å†™çš„é¡ºåºï¼Œä½†æ˜¯ä¸ä¿è¯è¯»å†™çš„å€¼æ˜¯å¦æœ‰æ•ˆï¼Œåè€…æ˜¯ç”± atomic è´Ÿè´£ä¿è¯çš„ï¼Œåªæ˜¯æ°å·§ x86 ä¸‹ç»å¤§å¤šæ•°è¯»å†™æ“ä½œéƒ½æ˜¯åŸå­çš„ï¼Œä¸€å®šè¦åŒºåˆ†å¥½ä¸¤è€…çš„å…³ç³» orzã€‚&lt;/p>
&lt;p>å¦ä¸€ä¸ªç²—æš´çš„æ–¹æ³•å°±æ˜¯æ‰€æœ‰ mov æ“ä½œéƒ½å¸¦ä¸Š lock prefixï¼Œä¿è¯ total orderã€‚&lt;/p>
&lt;p>æ€»è€Œè¨€ä¹‹ï¼Œå¤šæ ¸å¿ƒä¸‹ x86 å†…å­˜åºèƒ½ä¿è¯çš„åªæœ‰å†™å…¥çš„é¡ºåºï¼Œä»¥åŠâ€œå› æœå¾‹â€è¯»åˆ°çš„ç»“æœï¼›ä½†æ˜¯æ— æ³•ä¿è¯å¤šæ ¸å¿ƒä¸‹è¯»å’Œå†™çš„é¡ºåºï¼Œè¦ä¿è¯è¿™ç§é¡ºåºéœ€è¦ä¾é å†…å­˜å±éšœæˆ–æ˜¯æ€»çº¿é”ã€‚&lt;/p>
&lt;h2 id="å†…å­˜å±éšœmemory-fence">å†…å­˜å±éšœï¼ˆMemory Fenceï¼‰&lt;/h2>
&lt;p>å‰æ–‡åˆ—å‡ºçš„ SDM å· 3 8.2.2 èŠ‚é‡Œï¼Œç”¨äº†å¥½å‡ ä¸ªç‚¹å™è¿° &lt;code>xFENCE&lt;/code> æŒ‡ä»¤ï¼ŒåŒ…æ‹¬ &lt;code>LFENCE&lt;/code>ã€&lt;code>SFENCE&lt;/code> å’Œ &lt;code>MFENCE&lt;/code>ã€‚&lt;/p>
&lt;p>æ³¨æ„åˆ° SDM å· 3 8.2.5 èŠ‚é‡Œçš„ä¸€å¥è¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>The SFENCE instruction (introduced to the IA-32 architecture in the Pentium III processor) and the LFENCE and MFENCE instructions (introduced in the Pentium 4 processor) provide memory-ordering and serialization capabilities &lt;strong>for specific types of memory operations.&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>ä¹Ÿå°±æ˜¯è¯´å±éšœåœ¨ x86 ä¸‹åŸºæœ¬åªæœ‰â€œç‰¹æ®Šâ€çš„å†…å­˜æ“ä½œæ‰éœ€è¦ã€‚æ‰€ä»¥å…ˆæœ‰ä¸€ä¸ªæ¦‚å¿µï¼šx86â€œå¸¸è§„â€çš„æŒ‡ä»¤ä¸‹ä¸æ˜¯å¾ˆéœ€è¦å†…å­˜å±éšœã€‚é‚£ä¹ˆæˆ‘ä»¬ç»§ç»­å¾€ä¸‹å°±èƒ½çœ‹åˆ°è¿™ä¸‰æ¡æŒ‡ä»¤çš„å®šä¹‰ï¼š&lt;/p>
&lt;blockquote>
&lt;p>The SFENCE, LFENCE, and MFENCE instructions provide a performance-efficient way of ensuring load and store memory ordering between routines that &lt;strong>produce weakly-ordered results&lt;/strong> and routines that consume that data. The functions of these instructions are as follows:&lt;/p>
&lt;ul>
&lt;li>SFENCE â€” Serializes all store (write) operations that occurred prior to the SFENCE instruction in the program instruction stream, but does not affect load operations.&lt;/li>
&lt;li>LFENCE â€” Serializes all load (read) operations that occurred prior to the LFENCE instruction in the program instruction stream, but does not affect store operations.2&lt;/li>
&lt;li>MFENCE â€” Serializes all store and load operations that occurred prior to the MFENCE instruction in the program instruction stream.&lt;/li>
&lt;/ul>
&lt;p>&lt;em>2. Specifically, LFENCE does not execute until all prior instructions have completed locally, and no later instruction begins execution until LFENCE completes. As a result, an instruction that loads from memory and that precedes an LFENCE receives data from memory prior to completion of the LFENCE. An LFENCE that follows an instruction that stores to memory might complete before the data being stored have become globally visible. Instructions following an LFENCE may be fetched from memory before the LFENCE, but they will not execute until the LFENCE completes.&lt;/em>&lt;/p>
&lt;/blockquote>
&lt;p>ä¸Šé¢åŠ ç²—çš„é‚£å¥â€œproduce weakly-ordered resultsâ€ï¼Œå…¶å®ä¹Ÿè¯´æ˜äº† x86 ä¸ä»…ä»…åªæœ‰ TSOï¼Œä¸ºäº†æ€§èƒ½å®ƒä¹Ÿæœ‰æ›´å¼±çš„å†…å­˜æ¨¡å‹ï¼ˆå¦‚ ARMã€RISC-V èˆ¬çš„ï¼‰ã€‚&lt;/p>
&lt;p>å›å½’æ­£é¢˜ï¼Œç¨å¾®åœ°é˜è¿°ä¸€ä¸‹è¿™ä¸‰æ¡å†…å­˜å±éšœæŒ‡ä»¤ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>SFENCE&lt;/code> ä¼šä¿è¯è¯¥æŒ‡ä»¤ä¹‹å‰çš„æ‰€æœ‰ Store æ“ä½œä¸ä¼šâ€œè·¨è¿‡â€è¯¥æŒ‡ä»¤ï¼ˆå¯èƒ½ä¹Ÿæ˜¯â€œSerializesâ€çš„æ„æ€ï¼Ÿï¼‰ï¼Œä½†æ˜¯ä¸å¯¹ Load åšä»»ä½•ä¿è¯&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>LFENCE&lt;/code> åˆ™ä¿è¯è¯¥æŒ‡ä»¤ä¹‹å‰çš„æ‰€æœ‰ Load æ“ä½œä¸ä¼šâ€œè·¨è¿‡â€è¯¥æŒ‡ä»¤ï¼Œä¹ŸåŒæ ·ä¸å¯¹ Store åšä»»ä½•ä¿è¯ï¼›æ³¨æ„è¿™é‡Œå¸¦äº†ä¸€æ¡å°¾æ³¨ï¼ŒæŒ‡æ˜ &lt;code>LFENCE&lt;/code> ä¸ä»…ä»…èƒ½åŒæ­¥æ•°æ®ï¼Œä¹Ÿèƒ½åŒæ­¥æŒ‡ä»¤ï¼Œåœ¨å…¶ä»–æŒ‡ä»¤æ²¡æœ‰æ‰§è¡Œå®Œå‰ä¸ä¼šæ‰§è¡Œ &lt;code>LFENCE&lt;/code>ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ª&lt;a href="https://www.zhihu.com/question/29465982/answer/44465936">çŸ¥ä¹å›ç­”&lt;/a>è¯´æ˜äº†è¿™ä¸ªç‰¹æ€§è¢«ç”¨åœ¨äº†å†…æ ¸ &lt;code>RDTSC&lt;/code> ä¹‹å‰ï¼Œä»¥è·å–æ›´åŠ ç²¾ç¡®çš„æ—¶é’Ÿã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>MFENCE&lt;/code> åˆ™ä¼šä¿è¯ä¹‹å‰æ‰€æœ‰çš„ Store/Load æ“ä½œéƒ½ä¸ä¼šâ€œè·¨è¿‡â€è¯¥æŒ‡ä»¤ï¼›æ³¨æ„åœ¨æ±‡ç¼–çš„ä¸–ç•Œä¸­ï¼ˆæˆ‘è®¤ä¸ºï¼‰å•æ¡æŒ‡ä»¤æ°¸è¿œä¸ç­‰ä»·äºå¤šæ¡æŒ‡ä»¤çš„â€œå’Œâ€ï¼Œä¾‹å¦‚è¿™é‡Œçš„ &lt;code>MFENCE != SFENCE + LFENCE&lt;/code>ï¼ŒåŸå› å°±æ˜¯â€œåŸå­æ€§â€ï¼Œå¦‚æœç”¨ &lt;code>SFENCE + LFENCE&lt;/code> æ›¿ä»£ &lt;code>MFENCE&lt;/code> çš„è¯ï¼Œæœ‰ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜å°±æ˜¯ä¸¤æ¡æŒ‡ä»¤ä¸­é—´æœ‰å¯èƒ½å­˜åœ¨ä¸€å®šçš„â€œç©ºçª—æœŸâ€ï¼šåœ¨ä¸¤æ¡æŒ‡ä»¤ä¸­é—´ï¼Œè™½ç„¶ &lt;code>SFENCE&lt;/code> ä¿è¯äº†å½“å‰æ ¸å¿ƒä¹‹å‰çš„æ‰€æœ‰ Store æŒ‡ä»¤éƒ½å®Œæˆäº†ï¼Œä½†æ˜¯ç°åœ¨ç©ºçª—æœŸé—´ï¼ˆæ‰§è¡Œ &lt;code>LFENCE&lt;/code> å‰ï¼‰æˆ‘ä»¬å·²ç»ä¸èƒ½å†ä¿è¯ Store-Store åºäº†ï¼Œå› ä¸ºå…¶ä»– CPU å¯èƒ½ä¼šæ‰§è¡Œä»»ä½•çš„è¯»å†™æ“ä½œã€‚è¿™ä¸€ç‚¹åœ¨ &lt;a href="https://preshing.com/20120710/memory-barriers-are-like-source-control-operations/#storeload">Preshing çš„æ–‡ç« &lt;/a>ä¸­ä¹ŸæåŠåˆ°äº†ï¼š&lt;/p>
&lt;blockquote>
&lt;p>However, those two barrier types are insufficient. Remember, the push operation may be delayed for an arbitrary number of instructions, and the pull operation might not pull from the head revision.&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥åœ¨æ±‡ç¼–ä¸Šæˆ‘ä»¬å¿…é¡»è¦æœ‰ä¸€ä¸ª single instrument æ¥ä¿è¯ atomicityï¼Œè¿™è·Ÿ &lt;code>inc&lt;/code>ã€&lt;code>xchg&lt;/code> ç­‰â€œæ··åˆâ€æŒ‡ä»¤çš„ä½œç”¨æ˜¯ç±»ä¼¼çš„ï¼Œè™½ç„¶å®ƒä»¬éƒ½èƒ½æ‹†åˆ†æˆå¤šä¸ªæŒ‡ä»¤ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯åŸå­æ€§å¿…é¡»è¦æä¾›ï¼ˆå°±ç®—éå¸¸ç²¾ç®€ä»¥åŠ weakly-ordered çš„ RISC-V æ¶æ„ä¾ç„¶å­˜åœ¨ç€ &lt;code>xchg&lt;/code> è¿™æ ·çš„æŒ‡ä»¤ï¼Œæ¥ä¿è¯åŸå­æ€§ï¼‰ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>æ€»è€Œè¨€ä¹‹ï¼Œé€šå¸¸æ“ä½œä¸‹æˆ‘ä»¬å¹¶ä¸éœ€è¦å…³å¿ƒ x86 çš„å†…å­˜å±éšœï¼Œå› ä¸ºå®ƒå·²ç»â€œè¶³å¤Ÿçš„å¼ºâ€äº†ï¼Œä½†æ˜¯é¢å¯¹å…¶ä»–æƒ…å†µä¸‹ä¾ç„¶éœ€è¦å±éšœã€‚&lt;/p>
&lt;p>P.S. æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€æ®µè¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Intel does not guarantee that future processors will support this model.&lt;/p>
&lt;/blockquote>
&lt;p>çœ‹æ¥ Intel ä¹Ÿéå¸¸æƒ³åºŸå¼ƒæ‰ TSO å•Šï¼ˆç¬‘ï¼‰ã€‚&lt;/p>
&lt;h2 id="sequentially-consistent">Sequentially Consistent&lt;/h2>
&lt;p>å†…å­˜å±éšœçš„å…¶ä¸­ä¸€ä¸ªä½œç”¨ï¼Œå°±æ˜¯å°† TSO å†…å­˜åºå˜ä¸ºæ›´å¼ºçš„ SC å†…å­˜åºï¼Œå…·ä½“åšæ³•å‚è€ƒ &lt;a href="https://stackoverflow.com/a/27635527">StackOverflow çš„ç­”æ¡ˆ&lt;/a>ï¼Œé‡Œé¢åˆ—å‡ºäº†å››ç§åšæ³•ï¼š&lt;/p>
&lt;blockquote>
&lt;ol>
&lt;li>&lt;code>LOAD&lt;/code> (without fence) and &lt;code>STORE&lt;/code> + &lt;code>MFENCE&lt;/code>&lt;/li>
&lt;li>&lt;code>LOAD&lt;/code> (without fence) and &lt;code>LOCK XCHG&lt;/code>&lt;/li>
&lt;li>&lt;code>MFENCE&lt;/code> + &lt;code>LOAD&lt;/code> and &lt;code>STORE&lt;/code> (without fence)&lt;/li>
&lt;li>&lt;code>LOCK XADD&lt;/code> ( 0 ) and &lt;code>STORE&lt;/code> (without fence)&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>å¹¶ä¸”æŒ‡å‡º GCC ä½¿ç”¨çš„å°±æ˜¯æ–¹æ³• 1ï¼Œä¹Ÿå°±æ˜¯ &lt;code>STORE + MFENCE&lt;/code> å°±èƒ½å°† TSO è½¬å˜ä¸º SCã€‚è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ï¼Œå› ä¸º &lt;code>MFENCE&lt;/code> ä¿è¯äº†æŒ‡ä»¤ä¹‹å‰çš„&lt;strong>æ‰€æœ‰è¯»å†™&lt;/strong>æ“ä½œéƒ½å¯¹å…¶ä»–æ ¸å¿ƒå¯è§ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æ¯æ¬¡å†™çš„æ—¶å€™éƒ½æ‰§è¡Œä¸€æ¬¡ &lt;code>MFENCE&lt;/code>ï¼Œå°±æ„å‘³ç€æ¯æ¬¡å†™å®Œå°±å»å¼ºåˆ¶è¯»å†™å¯è§ï¼Œé‚£ä¹ˆåé¢çš„è¯»å°±å¿…å®šåªä¼šè¯»åˆ°æœ€æ–°çš„æŒ‡ã€‚å¦å¤–å› ä¸º SC è¦ä¿è¯ StoreLoadï¼Œæ‰€ä»¥å°±å¿…é¡»è¦ &lt;code>MFENCE&lt;/code>ï¼ˆï¼Ÿï¼‰ã€‚&lt;/p>
&lt;h2 id="non-temporal">Non-Temporal&lt;/h2>
&lt;p>ä¸Šé¢æåˆ°äº†å¯¹äº NTï¼ˆNon-Temporalï¼‰æ“ä½œï¼Œæˆ‘ä»¬æ˜¯ä¸èƒ½ä¿è¯ Store-Store åºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ª NT æŒ‡ä»¤åç«‹åˆ»æ¥ä¸Šå¦å¤–çš„ Store æŒ‡ä»¤ï¼Œé‚£ä¹ˆæœ€ç»ˆçš„ç»“æœæ˜¯æ— æ³•ç¡®å®šçš„ï¼Œè¿™ä¹Ÿæ˜¯ x86 ä¸­ relaxed-order çš„ä½“ç°ã€‚æ‰€ä»¥å¯¹äºæ‰€æœ‰çš„ NT æŒ‡ä»¤ï¼Œéƒ½å»ºè®®å¸¦ä¸Š &lt;code>SFENCE&lt;/code> å†…å­˜å±éšœã€‚&lt;/p>
&lt;blockquote>
&lt;p>Non-Temporal SSE instructions (MOVNTI, MOVNTQ, etc.), don&amp;rsquo;t follow the normal cache-coherency rules. Therefore non-temporal stores must be followed by an SFENCE instruction in order for their results to be seen by other processors in a timely fashion.&lt;/p>
&lt;p>When data is produced and not (immediately) consumed again, the fact that memory store operations read a full cache line first and then modify the cached data is detrimental to performance. This operation pushes data out of the caches which might be needed again in favor of data which will not be used soon. This is especially true for large data structures, like matrices, which are filled and then used later. Before the last element of the matrix is filled the sheer size evicts the first elements, making caching of the writes ineffective.&lt;/p>
&lt;p>For this and similar situations, processors provide support for non-temporal write operations. Non-temporal in this context means the data will not be reused soon, so there is no reason to cache it. These non-temporal write operations do not read a cache line and then modify it; instead, the new content is directly written to memory.&lt;/p>
&lt;p>Source: &lt;a href="http://lwn.net/Articles/255364/">http://lwn.net/Articles/255364/&lt;/a> &lt;a href="https://stackoverflow.com/a/37092">https://stackoverflow.com/a/37092&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>NT ä¸å¦å…¶å®æ˜¯è·Ÿ cache æœ‰å¾ˆå¤§å…³ç³»ï¼Œè¿™é‡Œçš„è§£é‡Šè¯´æ˜¯ Non-Temporal çš„æ‰€æœ‰æ“ä½œéƒ½ä¸èµ° cacheï¼ˆæ‰€ä»¥æ‰å«â€œéä¸´æ—¶â€ï¼Ÿï¼‰ã€‚è¿˜æ˜¯ç¿»ä¸€ä¸‹ SDM å§ï¼Œé¦–å…ˆç›´æ¥æ‰¾åˆ° &lt;code>MOVNTDQA&lt;/code> çš„æŒ‡ä»¤ä»‹ç»å§ï¼Œåœ¨å· 2 4.3 ä¸­ï¼Œæ‘˜å½•å…³äº Non-Temporal çš„éƒ¨åˆ†ï¼š&lt;/p>
&lt;blockquote>
&lt;p>The non-temporal hint is implemented by using a write combining (WC) memory type protocol when reading the data from memory. Using this protocol, the processor does not read the data into the cache hierarchy, nor does it fetch the corresponding cache line from memory into the cache hierarchy. The memory type of the region being read can override the non-temporal hint, if the memory address specified for the non-temporal read is not a WC memory region. Information on non-temporal reads and writes can be found in â€œCaching of Temporal vs. Non-Temporal Dataâ€ in Chapter 10 in the IntelÂ® 64 and IA-32 Architecture Software Developerâ€™s Manual, Volume 3A.&lt;/p>
&lt;p>Because the WC protocol uses a weakly-ordered memory consistency model, a fencing operation implemented with a MFENCE instruction should be used in conjunction with MOVNTDQA instructions if multiple processors might use different memory types for the referenced memory locations or to synchronize reads of a processor with writes by other agents in the system. A processorâ€™s implementation of the streaming load hint does not override the effective memory type, but the implementation of the hint is processor dependent. For example, a processor implementation may choose to ignore the hint and process the instruction as a normal MOVDQA for any memory type. Alternatively, another implementation may optimize cache reads generated by MOVNTDQA on WB memory type to reduce cache evictions.&lt;/p>
&lt;/blockquote>
&lt;p>è¿™é‡Œç®€è¦åœ°è¯´æ˜äº†è¿™ä¸ªæŒ‡ä»¤çš„ä¸€äº›ç»†èŠ‚ï¼Œä¾‹å¦‚å®ƒçš„ä½œç”¨å°±æ˜¯å°†å†…å­˜ä¸­çš„æ•°æ®è¯»åˆ°å¯„å­˜å™¨ä¸­ï¼Œä½†æ˜¯ä¸ç»è¿‡ç¼“å­˜å±‚ï¼ˆä¹Ÿä¸è§¦å‘ä»»ä½•çš„ fetchï¼‰ï¼Œç¬¬äºŒæ®µåˆ™æŒ‡å‡ºäº†è¯¥æŒ‡ä»¤å·¥ä½œåœ¨ weakly-ordered çš„å†…å­˜åºä¸‹ï¼Œå› æ­¤éœ€è¦å€ŸåŠ©å‰æ–‡è¯´çš„å†…å­˜å±éšœæ¥ä¿è¯å¯è§æ€§ï¼ˆä»¥åŠé¡ºåºæ€§ï¼‰ã€‚é¡ºä¾¿è¿™é‡Œä¹ŸæŒ‡è·¯åˆ°äº† SDM å· 1 10.4.6.2ï¼ˆè·ŸåŸæ–‡çš„å·å·å¯¹ä¸ä¸Šï¼Œæ ‡é”™äº†ï¼Ÿï¼‰ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Data referenced by a program can be temporal (data will be used again) or non-temporal (data will be referenced once and not reused in the immediate future). For example, program code is generally temporal, whereas, multimedia data, such as the display list in a 3-D graphics application, is often non-temporal. &lt;strong>To make efficient use of the processorâ€™s caches, it is generally desirable to cache temporal data and not cache non-temporal data.&lt;/strong> Overloading the processorâ€™s caches with non-temporal data is sometimes referred to as â€œpolluting the caches.â€ The SSE and SSE2 cacheability control instructions enable a program to write non-temporal data to memory in a manner that minimizes pollution of caches.&lt;/p>
&lt;/blockquote>
&lt;p>ä¹Ÿå°±æ˜¯è¯´ NT å®½æ³›æ¥è¯´ï¼ˆæ¦‚å¿µæ€§ï¼‰æŒ‡çš„å°±æ˜¯ä¸ä¼šç«‹åˆ»è¢«ä½¿ç”¨åˆ°çš„æ•°æ®ï¼Œä¹Ÿå› æ­¤å‡ºäºæ€§èƒ½è€ƒè™‘ä¹Ÿå°±ä¸å†è¿›è¡Œç¼“å­˜ï¼Œå°†ç¼“å­˜è®©ç»™ temporal dataã€‚å› æ­¤ä»å®ç°è§’åº¦æ¥è¯´ NT å°±æ˜¯ä¸ç»è¿‡ç¼“å­˜çš„æ•°æ®ï¼Œè€ƒæ®ç»ˆäº†ã€‚&lt;/p>
&lt;p>P.S. åœ¨ SDM å· 3 11.3 ä¸­èƒ½æ‰¾åˆ°æ‰€æœ‰çš„ Memory Types å’Œç›¸å…³è§£é‡Šã€‚ä¸è´´åŸæ–‡äº†ï¼Œæ•´ç†ï¼ˆç²—ç•¥åœ°ç†è§£ï¼‰äº†ä¸€ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>Write Combining (WC)ï¼šå¯¹äºä¸€äº›æ— æ³•è¢«ç¼“å­˜ï¼ˆcacheï¼‰çš„é¡¹ç›®ï¼Œä¼šå­˜åœ¨ä¸€ä¸ªä¸“é—¨çš„ bufferï¼ˆwrite combining bufferï¼‰æ¥æ”¶é›†å¹¶â€œèšåˆâ€ï¼ˆcombineï¼‰è¿™äº›è¯»å†™æ“ä½œå¹¶æ¨è¿Ÿå†™å…¥ï¼Œä»¥æ­¤æ¥å‡å°‘å†…å­˜ï¼ˆæˆ–è€… I/Oï¼‰çš„è¯»å†™æ¬¡æ•°ï¼›ä¸€äº› serializing æŒ‡ä»¤ï¼ˆå¦‚ä¸Šé¢æåˆ°çš„ &lt;code>SFENCE&lt;/code>ã€&lt;code>MFENCE&lt;/code> ä»¥åŠ &lt;code>CPUID&lt;/code> ç­‰ï¼‰ä¼šå¼ºè¡Œè½åœ°å¹¶æ¸…ç©º WC Cacheã€‚æ›´å¤šå…³äº WC Buffer å¯ä»¥å‚è€ƒ &lt;a href="https://stackoverflow.com/a/49961612">StackOverflow ä¸Šçš„ç­”æ¡ˆ&lt;/a>ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä¹Ÿæ²¡ä»”ç»†åœ°å»çœ‹äº† orzã€‚&lt;/li>
&lt;li>Write-through (WT)ï¼šæ‰€æœ‰çš„ Load/Store éƒ½èµ° cacheï¼Œä½†æ˜¯æ¯æ¬¡åœ¨å¾€ cache ä¸­å†™å…¥ï¼ˆStoreï¼‰æ—¶éƒ½ä¼šç›´æ¥åŒæ­¥åˆ°å†…å­˜ä¸­ï¼›è¯»å–ï¼ˆLoadï¼‰åˆ™ä¾ç„¶ä¼šä» cache ä¸­è¯»å–ã€‚å› æ­¤ WT æ¯”è¾ƒé€‚åˆå†™ä¸æ•æ„Ÿï¼Œä½†æ˜¯è¦æ±‚ä¸å†…å­˜ä¿æŒåŒæ­¥çš„ä¸€äº›åœºæ™¯ï¼ˆI/Oï¼Ÿï¼‰ã€‚&lt;/li>
&lt;li>Write-back (WB)ï¼šæ‰€æœ‰çš„ Load/Store éƒ½èµ° cacheï¼Œæ•°æ®ä¼šä¿æŒåœ¨ cache ä¸­ç›´åˆ°ç¼“å­˜ç­–ç•¥å†³å®šè¯¥ä½•æ—¶å†™å›åˆ°å†…å­˜ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨ï¼ˆä¹Ÿæ˜¯æ€§èƒ½æœ€å¥½çš„ï¼‰ä¸€ç§ cache æ¨¡å¼ã€‚ä½†æ˜¯å¯¹äº I/O ç­‰éœ€è¦è®¿é—®å†…å­˜çš„å¤–è®¾ï¼ˆdeviceï¼‰è‚¯å®šå°±éœ€è¦è€ƒè™‘ä¸€è‡´æ€§çš„é—®é¢˜äº†ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦è€ƒè™‘ç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜ï¼ˆcache coherencyï¼‰ã€‚&lt;/li>
&lt;li>Write protected (WP)ï¼šåªå¯¹ Load æ“ä½œèµ° cacheï¼Œæ‰€æœ‰çš„ Store çš„æ“ä½œéƒ½ä¼šè®©ç¼“å­˜å¤±æ•ˆã€‚&lt;/li>
&lt;/ul>
&lt;p>P.P.S. æœ‰ä¸€ä¸ª &lt;code>PREFETCH&lt;/code> æŒ‡ä»¤å¯ä»¥æ˜¾å¼åœ°å°†éƒ¨åˆ†å†…å­˜è½½å…¥åˆ°ç¼“å­˜ä¸­ï¼Œè¿™ä¹Ÿæ˜¯åœ¨å†…æ ¸ä»£ç é‡Œçœ‹åˆ°å¾ˆå¤š prefetch çš„åŸç†ã€‚å…·ä½“å¯ä»¥çœ‹æŒ‡ä»¤è¯´æ˜ã€‚&lt;/p>
&lt;h2 id="follymemcpys">folly/memcpy.S&lt;/h2>
&lt;p>è¿™é‡Œæˆ‘çš„å…´è¶£ç‚¹åœ¨äº &lt;code>.L_NON_TEMPORAL_LOOP&lt;/code> è¿™ä¸ª label ä¸Šï¼Œé¦–å…ˆå¯ä»¥æ‰¾åˆ°å“ªé‡Œä¼šè·³è½¬åˆ°è¿™é‡Œæ¥ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nasm" data-lang="nasm">&lt;span class="line">&lt;span class="cl">&lt;span class="err">//&lt;/span> &lt;span class="nf">This&lt;/span> &lt;span class="nv">threshold&lt;/span> &lt;span class="nv">is&lt;/span> &lt;span class="nv">half&lt;/span> &lt;span class="nv">of&lt;/span> &lt;span class="nv">L1&lt;/span> &lt;span class="nv">cache&lt;/span> &lt;span class="nv">on&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">Skylake&lt;/span> &lt;span class="nv">machine&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">which&lt;/span> &lt;span class="nv">means&lt;/span> &lt;span class="nv">that&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">//&lt;/span> &lt;span class="nf">potentially&lt;/span> &lt;span class="nb">al&lt;/span>&lt;span class="nv">l&lt;/span> &lt;span class="nv">of&lt;/span> &lt;span class="nv">L1&lt;/span> &lt;span class="nv">will&lt;/span> &lt;span class="nv">be&lt;/span> &lt;span class="nv">populated&lt;/span> &lt;span class="nv">by&lt;/span> &lt;span class="nv">this&lt;/span> &lt;span class="nv">copy&lt;/span> &lt;span class="nv">once&lt;/span> &lt;span class="nv">it&lt;/span> &lt;span class="nv">is&lt;/span> &lt;span class="nv">executed&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">//&lt;/span> &lt;span class="err">(&lt;/span>&lt;span class="nf">dst&lt;/span> &lt;span class="nv">and&lt;/span> &lt;span class="nv">src&lt;/span> &lt;span class="nv">are&lt;/span> &lt;span class="nv">cached&lt;/span> &lt;span class="nv">for&lt;/span> &lt;span class="nv">temporal&lt;/span> &lt;span class="nv">copies&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="nv">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">#&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="nv">NON_TEMPORAL_STORE_THRESHOLD&lt;/span> &lt;span class="kc">$&lt;/span>&lt;span class="mi">32768&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">cmp&lt;/span> &lt;span class="nv">NON_TEMPORAL_STORE_THRESHOLD&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nb">rdx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">jae&lt;/span> &lt;span class="nv">.L_NON_TEMPORAL_LOOP&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬ &lt;code>memcpy&lt;/code> çš„å¤§å°è¶…è¿‡äº† L1 ç¼“å­˜ï¼ˆfolly å–äº† Skylake ä½œä¸ºåŸºå‡†ï¼‰åï¼Œå°±ä¸å†å€ŸåŠ©ç¼“å­˜å»æ‹·è´äº†ï¼Œè€Œæ˜¯ç›´æ¥åˆ©ç”¨ä¸Šè¿°çš„ &lt;code>MOVNTx&lt;/code> ç³»åˆ—çš„ NT æŒ‡ä»¤ç»•è¿‡ç¼“å­˜ï¼Œå®ç°æ¯”è¾ƒé«˜æ€§èƒ½çš„æ‹·è´ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nasm" data-lang="nasm">&lt;span class="line">&lt;span class="cl">&lt;span class="nl">.L_NON_TEMPORAL_LOOP:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">testb&lt;/span> &lt;span class="kc">$&lt;/span>&lt;span class="mi">31&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nb">si&lt;/span>&lt;span class="nv">l&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">jne&lt;/span> &lt;span class="nv">.L_ALIGNED_DST_LOOP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">//&lt;/span> &lt;span class="nf">This&lt;/span> &lt;span class="nv">is&lt;/span> &lt;span class="nv">prefetching&lt;/span> &lt;span class="nv">the&lt;/span> &lt;span class="nv">source&lt;/span> &lt;span class="nv">data&lt;/span> &lt;span class="nv">unlike&lt;/span> &lt;span class="nb">AL&lt;/span>&lt;span class="nv">IGNED_DST_LOOP&lt;/span> &lt;span class="nv">which&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">//&lt;/span> &lt;span class="nf">prefetches&lt;/span> &lt;span class="nv">the&lt;/span> &lt;span class="nv">destination&lt;/span> &lt;span class="nv">data.&lt;/span> &lt;span class="nv">This&lt;/span> &lt;span class="nb">ch&lt;/span>&lt;span class="nv">oice&lt;/span> &lt;span class="nv">is&lt;/span> &lt;span class="nv">again&lt;/span> &lt;span class="nv">informed&lt;/span> &lt;span class="nv">by&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">//&lt;/span> &lt;span class="nf">benchmarks.&lt;/span> &lt;span class="nv">With&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">non&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nv">temporal&lt;/span> &lt;span class="nv">store&lt;/span> &lt;span class="nv">the&lt;/span> &lt;span class="nv">entirety&lt;/span> &lt;span class="nv">of&lt;/span> &lt;span class="nv">the&lt;/span> &lt;span class="nv">cache&lt;/span> &lt;span class="nv">line&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">//&lt;/span> &lt;span class="nf">is&lt;/span> &lt;span class="nv">being&lt;/span> &lt;span class="nv">written&lt;/span> &lt;span class="nv">so&lt;/span> &lt;span class="nv">the&lt;/span> &lt;span class="nv">previous&lt;/span> &lt;span class="nv">data&lt;/span> &lt;span class="nv">can&lt;/span> &lt;span class="nv">be&lt;/span> &lt;span class="nb">di&lt;/span>&lt;span class="nv">scarded&lt;/span> &lt;span class="nv">without&lt;/span> &lt;span class="nv">being&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">//&lt;/span> &lt;span class="nf">fetched.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">prefetchnta&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="nb">rsi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">prefetchnta&lt;/span> &lt;span class="mi">196&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="nb">rsi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">vmovntdqa&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="nb">rsi&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nv">ymm0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">vmovntdqa&lt;/span> &lt;span class="mi">32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="nb">rsi&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nv">ymm1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">vmovntdqa&lt;/span> &lt;span class="mi">64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="nb">rsi&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nv">ymm2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">vmovntdqa&lt;/span> &lt;span class="mi">96&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="nb">rsi&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nv">ymm3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">add&lt;/span> &lt;span class="kc">$&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nb">rsi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">vmovntdq&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nv">ymm0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="nb">rdi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">vmovntdq&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nv">ymm1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="nb">rdi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">vmovntdq&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nv">ymm2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="nb">rdi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">vmovntdq&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nv">ymm3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">96&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="nb">rdi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">add&lt;/span> &lt;span class="kc">$&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nb">rdi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">cmp&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nv">r8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="nb">rsi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">jb&lt;/span> &lt;span class="nv">.L_NON_TEMPORAL_LOOP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">sfence&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">jmp&lt;/span> &lt;span class="nv">.L_ALIGNED_DST_LOOP_END&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ° folly å€ŸåŠ© &lt;code>movntdqa&lt;/code> æŒ‡ä»¤å°†æ•°æ®è¯»å…¥åˆ° AVX å¯„å­˜å™¨ &lt;code>ymmX&lt;/code> ä¸­ï¼Œå†ä½¿ç”¨ &lt;code>movntdq&lt;/code> å°†å¯„å­˜å™¨çš„å€¼å†™å›åˆ°å†…å­˜ï¼Œå¹¶å¾ªç¯ã€‚æœ€åï¼Œæ³¨æ„åˆ°è¿™é‡Œè¿˜æœ‰ä¸ª &lt;code>sfence&lt;/code> æŒ‡ä»¤ï¼Œä¿è¯åœ¨æ‹·è´å®Œåæ•°æ®å¯¹å…¶ä»–æ ¸å¿ƒå¯è§ï¼ˆä½†æ˜¯æ‹·è´é€”ä¸­æ— æ³•ä¿è¯ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦è°ƒç”¨ç€ç¡®ä¿ä¸ä¼šå‡ºç° data raceï¼‰ï¼Œç¬¦åˆ SDM ä¸Šçš„å®šä¹‰ã€‚&lt;/p>
&lt;p>åˆ°æ­¤ï¼ŒåŸºæœ¬ä¸Šæˆ‘ä»¬ä¹Ÿç†è§£äº† x86 çš„ TSO å†…å­˜åºï¼ˆæ¯” SC å¼±çš„åœ°æ–¹åœ¨äºåªèƒ½ä¿è¯åŒä¸€ä¸ªåœ°å€çš„ Store-Loadï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ &lt;code>MFENCE&lt;/code> æŒ‡ä»¤åšåˆ°æ‰€æœ‰åœ°å€çš„ Store-Load ä»¥å®ç° SCï¼‰ã€x86 çš„å†…å­˜å±éšœçš„ä½œç”¨ï¼ˆé€šå¸¸ç¨‹åºä¸­å› ä¸º TSO çš„å­˜åœ¨æ²¡æœ‰ä»€ä¹ˆä½œç”¨ï¼Œä½†æ˜¯å¯¹äºå¦‚ NT ç³»åˆ—çš„ç‰¹æ®ŠæŒ‡ä»¤éœ€è¦ weakly-ordered memoryï¼Œå°±å¿…é¡»ä½¿ç”¨å†…å­˜å±éšœäº†ï¼›ä¸è¿‡ä¸ºäº†ç¨‹åºçš„ portable æ€§ï¼Œè¿˜æ˜¯å°½é‡åœ°åŠ ä¸Šå†…å­˜å±éšœæ“ä½œï¼Œä¹Ÿèƒ½åŠ æ·±ç†è§£ï¼‰ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥å°è¯•ç†è§£ï¼ˆå›°æ‰°æˆ‘å¤šå¹´çš„.jpgï¼‰C++ &lt;code>std::memory_order&lt;/code> äº†ã€‚&lt;/p>
&lt;h2 id="cache">Cache&lt;/h2>
&lt;p>å…³äº Memory Orderï¼Œå¶å°”è¿˜æ˜¯ä¼šæåˆ°ç¼“å­˜ï¼Œå› ä¸ºåƒ Intel x86 ç­‰ä¸»æµå®ç°æ¥è¯´ï¼ŒåŸºæœ¬éƒ½ä¼šå¸¦æœ‰ç¼“å­˜ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯¹å†…å­˜è¿›è¡Œæ“ä½œçš„æ—¶å€™å°±ä¼šå­˜åœ¨ä¸€ä¸ªä¸­é—´çš„ cache çŠ¶æ€ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜åºå‡ºç°ä¸€äº›å°å°çš„å·®å¼‚ï¼ˆä¾‹å¦‚å¦‚æœæœ‰ä¸€ä¸ªç®€å•çš„ cacheï¼Œæˆ‘ä»¬å¾€åŒä¸€ä¸ªå†…å­˜åœ°å€å¤šæ¬¡å†™å…¥æ•°æ®ï¼Œé‚£ä¹ˆå®é™…å°±åªæ˜¯ä¸€ç›´åœ¨å¾€ cache ä¸­å†™å…¥æ•°æ®ï¼Œæ²¡æœ‰&lt;em>åŠæ—¶åœ°&lt;/em>å†™å›åˆ°å†…å­˜ä¸­å»ï¼Œå…¶ä»– CPU å°±æ— æ³•è§‚æµ‹ï¼Œä¹Ÿå°±æ— æ³•ä¿è¯ Store-Load ç­‰å†…å­˜åºäº†ï¼‰ã€‚&lt;/p>
&lt;p>è¿™ä¸ªé—®é¢˜å°±äº¤ç”±ç¼“å­˜ä¸€è‡´æ€§ç®—æ³•æ¥è§£å†³ï¼Œæœ€ç»ˆå®ç°çš„æ•ˆæœå°±æ˜¯åœ¨ x86 ä¸‹æ— è®ºæˆ‘ä»¬æ€ä¹ˆæ“ä½œ cache å’Œå†…å­˜ï¼Œåªè¦åœ°å€ç›¸åŒï¼Œå°±èƒ½ä¿è¯å…¶ä»– CPU å§‹ç»ˆèƒ½è§‚æµ‹åˆ°æœ€æ–°å€¼ï¼Œä»è€Œä¿è¯ Store-Load åºæ­£ç¡®ï¼ˆä¸Šé¢çš„ä¾‹å­ä¹Ÿå°±ä¸ä¼šå‡ºç°æ— æ³•è§‚æµ‹çš„é—®é¢˜ï¼‰ã€‚è€Œå¯¹äºå…¶ä»–æ¶æ„è€Œè¨€ï¼Œåº”è¯¥ä¹Ÿéœ€è¦å®ç°ç±»ä¼¼çš„æ•ˆæœï¼Œèµ·ç æ˜¯éœ€è¦æœ‰å¤„ç† atomic çš„èƒ½åŠ›ï¼Œå³èƒ½è®©åˆ«çš„ CPU è§‚æµ‹åˆ°å¯¹å†…å­˜æ“ä½œçš„å˜åŒ–ã€‚&lt;/p>
&lt;p>å¯¹äº x86 è€Œè¨€ï¼Œå¸¸ç”¨çš„ç¼“å­˜ä¸€è‡´æ€§åè®®æ˜¯ MESIï¼Œè¿™ä¸ªåè®®æ¯”è¾ƒé‡è¦çš„å°±æ˜¯â€œå—…æ¢æœºåˆ¶â€ï¼ˆsnoopï¼‰ï¼Œä¹Ÿæ˜¯é€šè¿‡ snoop é€šè¿‡æ€»çº¿æ¥å¾—çŸ¥å…¶ä»– CPU çš„æ“ä½œï¼›å…·ä½“å¯ä»¥æŸ¥çœ‹&lt;a href="https://en.wikipedia.org/wiki/MESI_protocol">ç»´åŸºç™¾ç§‘ MESI&lt;/a> çš„é¡µé¢ï¼Œè¿™éƒ¨åˆ†æˆ‘æš‚æ—¶è¿˜æ²¡æ·±å…¥åœ°å»äº†è§£ï¼Œå¤§æ¦‚åªçŸ¥é“è¿™äº›äº†ï¼ˆé€ƒã€‚&lt;/p>
&lt;h2 id="ç¼–è¯‘å™¨çš„æŒ‡ä»¤é‡æ’">ç¼–è¯‘å™¨çš„æŒ‡ä»¤é‡æ’&lt;/h2>
&lt;p>æœ‰æ—¶å€™åœ¨å¤§é‡å­˜åœ¨å˜é‡çš„è¯»å†™æ—¶ï¼Œç¼–è¯‘å™¨ä¼šé€‰æ‹©æ€§åœ°è¿›è¡ŒæŒ‡ä»¤é‡æ’ï¼ˆä¾‹å¦‚ä½ èƒ½åœ¨ GDB ä¸­å‘ç°å¾ˆå¤šâ€œè¯¡å¼‚â€çš„è·³è½¬ï¼Œå¸¸å¸¸æ‰§è¡Œåˆ°ä¸€åŠçš„æ—¶å€™è·³å›åˆ°å¼€å¤´æ‰§è¡Œå˜é‡çš„åˆå§‹åŒ–ç­‰ï¼‰ï¼Œè¿™å°±æ˜¯åŒºåˆ«äº CPU æŒ‡ä»¤é‡æ’çš„ç¼–è¯‘å™¨æŒ‡ä»¤é‡æ’ã€‚ç¼–è¯‘å™¨é‡æ’åŸºæœ¬éƒ½æ˜¯åœ¨ç¼–è¯‘æœŸåšçš„ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥æŠ‘åˆ¶ï¼š&lt;/p>
&lt;ol>
&lt;li>å˜é‡ä½¿ç”¨ &lt;code>volatile&lt;/code> å…³é”®å­—ï¼Œé’ˆå¯¹çš„æ˜¯è¯¥å˜é‡ï¼›&lt;/li>
&lt;li>ä½¿ç”¨ &lt;code>asm volatile(&amp;quot;&amp;quot; ::: &amp;quot;memory&amp;quot;)&lt;/code>ï¼Œé’ˆå¯¹çš„æ˜¯è¯¥è¯­å¥ä¸Šä¸‹çš„é‡æ’ï¼Œè·Ÿ CPU çš„å†…å­˜å±éšœå¾ˆåƒï¼Œå°±æ˜¯é¿å…è¯­å¥ä¹‹å‰çš„è¯»å†™æ“ä½œé‡æ–°æ’åºåˆ°è¯¥è¯­å¥ä¹‹åã€‚å¦å¤–è¯­å¥èµ·ä½œç”¨çš„åœ°æ–¹æ˜¯ &lt;code>&amp;quot;memory&amp;quot;&lt;/code>ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªå‚æ•°æ— è®ºæ˜¯ä»»ä½•æ±‡ç¼–æŒ‡ä»¤éƒ½ä¼šæœ‰æŠ‘åˆ¶ç¼–è¯‘å™¨é‡æ’çš„æ•ˆæœã€‚&lt;/li>
&lt;/ol>
&lt;p>å¤§æ¦‚ä¹Ÿå°±æ˜¯è¿™äº›äº†ï¼Œæ–‡ç« é‡ç‚¹ä¾ç„¶åœ¨ x86 ä¸Šï¼Œæš‚æ—¶ä¸è®¨è®ºç¼–è¯‘å™¨äº†ï¼ˆå…¶å®æ˜¯ä¸ä¼š QAQï¼‰ã€‚&lt;/p>
&lt;p>åç»­ä¼šå†™ä¸€ç¯‡ C/C++ çš„ Memory Orderï¼Œæ¥å¯¹â€œçœŸå®ä¸–ç•Œâ€ä¸­çš„å†…å­˜æ¨¡å‹ï¼ˆå¸Œæœ›èƒ½ï¼‰æœ‰ä¸€ä¸ªæ›´ç¨å¾®é€å½»çš„ç†è§£&lt;del>ä»¥åŠå’•å’•å’•&lt;/del>ã€‚&lt;/p></description></item><item><title>å…³äº</title><link>https://collect.fn.pub/about/</link><pubDate>Fri, 09 Dec 2022 22:54:54 +0800</pubDate><guid>https://collect.fn.pub/about/</guid><description>&lt;h2 id="me-myself-and-i">Me, Myself, and I&lt;/h2>
&lt;ul>
&lt;li>ä¸å¤ªèµ·çœ¼çš„ä¸€åªé¶¸&lt;/li>
&lt;li>è£…æ‡‚ä»¥åŠå¼ºç­”æµä½œè€…&lt;/li>
&lt;li>å¤±ä¸šäººç¾¤&lt;/li>
&lt;/ul>
&lt;h2 id="blog">b:log().&lt;/h2>
&lt;ul>
&lt;li>åªæ˜¯æ–‡ç« çš„æ¬è¿å·¥&lt;/li>
&lt;li>å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯åœ¨èƒ¡è¯´&lt;/li>
&lt;li>å…¶ä»–æƒ…å†µä¸‹æ˜¯åœ¨ä¹±è¯´&lt;/li>
&lt;/ul>
&lt;h2 id="friends">Friends&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="http://www.zzfly.net">çƒŸèŠ±æ˜“å†·&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://virgilg72.github.io/">VirgilG72&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.yukicat.net/">é›ªçŒ«ç¤¾&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>ä¹±è°ˆ Monad</title><link>https://collect.fn.pub/2022/12-08-babble-monad/</link><pubDate>Thu, 08 Dec 2022 20:46:25 +0800</pubDate><guid>https://collect.fn.pub/2022/12-08-babble-monad/</guid><description>&lt;h2 id="preface">Preface&lt;/h2>
&lt;p>è¿™å‡ å¤©æŒ‰ç€æˆ‘åŠåŠå­çš„ haskell æ°´å¹³ç¨å¾®ç ”ç©¶äº†ä¸€ä¸‹ monadï¼Œè¿˜æ˜¯æœ‰ç‚¹ä¸æ˜¯å¾ˆç†è§£ï¼Œåªèƒ½æµ…æµ…åœ°è°ˆä¸€è°ˆæˆ‘è‡ªå·±çš„æƒ³æ³•ï¼Œé”™è¯¯å’Œçº°æ¼éš¾ä»¥é¿å…ï¼Œæ‰€è°“ä¹±è°ˆæ˜¯ä¹Ÿã€‚&lt;/p>
&lt;h2 id="the-moand">The Moand&lt;/h2>
&lt;p>è¿™éƒ¨åˆ†å°½é‡ä¼šè¯¦ç»†åœ°é˜è¿°ä¸€ä¸‹&lt;a href="https://www.zhihu.com/question/19635359/answer/172074046">åˆ˜æœˆåŠå¤§ç¥çš„è¿™ç¯‡æ–‡ç« &lt;/a>ï¼Œé€‚å½“çš„æ”¹åŠ¨äº†ä¸€äº›ä¾‹å­ï¼Œé¦–å…ˆä» &lt;code>Maybe&lt;/code> çš„æ„é€ å‡½æ•°å¼€å§‹ï¼Œ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">data&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Just&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ &lt;code>a&lt;/code> æ˜¯ä¸€ä¸ªç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥â€œå®ä¾‹åŒ–â€ä¸€ä¸ª &lt;code>Maybe Int&lt;/code> ç±»å‹å‡ºæ¥ç­‰ç­‰ï¼Œå¹¶ä¸”å­˜åœ¨ä¸¤ä¸ªâ€œæ„é€ å™¨â€ï¼Œ&lt;code>Just&lt;/code> å’Œ &lt;code>Nothing&lt;/code>ã€‚ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ª &lt;code>safeDiv&lt;/code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä½œç”¨æ˜¯ä¿è¯åœ¨é‡åˆ°é™¤é›¶é”™è¯¯æ—¶ä¸ä¼šè®©ç¨‹åº crashï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ª &lt;code>Maybe Int&lt;/code> ç±»å‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">safeDiv&lt;/span> &lt;span class="ow">::&lt;/span> &lt;span class="kt">Int&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Int&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">safeDiv&lt;/span> &lt;span class="kr">_&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">safeDiv&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Just&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="p">`&lt;/span>&lt;span class="n">div&lt;/span>&lt;span class="p">`&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">-- é™¤æ³•è¿ç®—ç¬¦ / ä¸èƒ½ä½œç”¨åœ¨ Int ä¸Š&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœæˆ‘ä»¬å¸Œæœ›ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„é™¤æ³•è¿ç®—ä¸­ï¼Œéƒ½èƒ½ä¿è¯é™¤é›¶å®‰å…¨çš„è¯ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™å‡ºä¸‹é¢è¿™æ ·çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- å®‰å…¨åœ°è®¡ç®— a/b/c/d/e&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">case&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="kr">of&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Nothing&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Just&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kr">case&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="kr">of&lt;/span> &lt;span class="c1">-- å¦‚æœ b != 0ï¼Œèƒ½å¤Ÿç»§ç»­è¿›è¡Œé™¤æ³•ï¼Œå°è¯•è®¡ç®— (a/b)/c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Nothing&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Just&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kr">case&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="kr">of&lt;/span> &lt;span class="c1">-- å¦‚æœ c != 0ï¼Œç»§ç»­å°è¯•è®¡ç®— (a/b/c)/d&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Nothing&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Just&lt;/span> &lt;span class="n">z&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">z&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="c1">-- å¦‚æœ d != 0ï¼Œç»§ç»­å°è¯•è®¡ç®— (a/b/c/d)/e&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ä»£ç éå¸¸çš„å•°å—¦ï¼Œè€Œä¸”çœ‹ç€å¾ˆéš¾å—ï¼ˆå¯¹åº”è¿‡ç¨‹å¼è¯­è¨€å°±æ˜¯ä¸€å±‚åˆä¸€å±‚çš„ if åµŒå¥—ï¼‰ï¼Œæœ‰æ²¡æœ‰åŠæ³•èƒ½ä¼˜åŒ–å‘¢ï¼Ÿå®é™…ä¸Šä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä»å‡ ä¸ª &lt;code>case&lt;/code> ä¸­æå–å‡ºä¸€äº›å…¬å…±ç‰¹å¾ï¼ˆä¼ªä»£ç ï¼Œ&lt;code>{Int}&lt;/code> è¡¨ç¤ºæ­¤å¤„çš„å˜é‡ç±»å‹ä¸º &lt;code>Int&lt;/code>ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- å°† safeDiv x c ä½¿ç”¨ \x -&amp;gt; safeDiv x c æ›¿æ¢ï¼Œå³å¯å¾—åˆ°æœ€ç®€æ´çš„ Int -&amp;gt; Maybe Int å‡½æ•°ï¼›&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- å› ä¸ºè¢« lambda æ•è·çš„é‡åŸºæœ¬éƒ½èƒ½è¢«è§†ä½œå¸¸é‡ï¼ˆï¼Ÿï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">case&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="kr">of&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Nothing&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Just&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="kt">Int&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»™ä¸Šé¢çš„ç±»å‹é™„ä¸Šåå­—å’Œç±»å‹ï¼Œå°±æˆäº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fmap&amp;#39;&lt;/span> &lt;span class="ow">::&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Int&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fmap&amp;#39;&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="n">m&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kr">case&lt;/span> &lt;span class="n">m&lt;/span> &lt;span class="kr">of&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Nothing&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Just&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ª &lt;code>Maybe&lt;/code> çš„æ‰€è°“ functorï¼ˆå‡½å­ï¼‰ï¼Œ&lt;/p>
&lt;blockquote>
&lt;p>Maybe ä¹‹æ‰€ä»¥æ˜¯å‡½å­ï¼Œæ˜¯å› ä¸ºå®ƒå¯ä»¥é€šè¿‡ fmapï¼ˆfunctor mapï¼‰æŠŠæ‰€æœ‰çš„å‡½æ•°æ‹åˆ°ã€ŒMaybe ç©ºé—´ã€é‡Œã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æœ‰äº†å‡½å­ä¹‹åï¼Œæˆ‘ä»¬å°è¯•æŠŠè¿™ä¸ªæŠ½è±¡åº”ç”¨åˆ°æˆ‘ä»¬çš„ä¾‹å­ä¸Šå»çœ‹çœ‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">let&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="c1">-- ç¬¬ä¸€å±‚ a/b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">y&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">fmap&amp;#39;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">\&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="c1">-- ç¬¬äºŒå±‚ (a/b)/c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">z&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">fmap&amp;#39;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">\&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="c1">-- ç¬¬ä¸‰å±‚ (a/b/c)/d&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fmap&amp;#39;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">\&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">z&lt;/span> &lt;span class="c1">-- ç¬¬å››å±‚ (a/b/c/d)/e&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŠ›å¼€æ€§èƒ½ä¸è°ˆï¼ˆé›¾ï¼‰ï¼Œè¿™ç§å†™æ³•çœ‹èµ·æ¥å·²ç»èˆ’æœå¾ˆå¤šäº†ï¼Œä½†æ˜¯æ„Ÿè§‰è¿˜æ˜¯â€œå­˜åœ¨è¿›æ­¥ç©ºé—´â€çš„æ ·å­ã€‚ä¹Ÿçš„ç¡®ï¼Œhaskell ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª &lt;code>&amp;gt;&amp;gt;=&lt;/code> è¿ç®—ç¬¦ï¼Œå¯ä»¥è®©æˆ‘ä»¬æ¥å®ç° &lt;code>fmap&lt;/code>ï¼Œå¹¶ä¸”å†æ¬¡ä¼˜åŒ–ä¸Šé¢çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- è¿™æ˜¯ä¸€ä¸ªä¸­ç¼€è¿ç®—ç¬¦ï¼Œè¿™ä¸ªä¾‹å­ä¸­ (&amp;gt;&amp;gt;=) m f ç­‰ä»·äº m &amp;gt;&amp;gt;= fï¼›å®šä¹‰ä¸ fmap&amp;#39; å®Œå…¨ä¸€è‡´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;=&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">::&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Int&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;=&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">m&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kr">case&lt;/span> &lt;span class="n">m&lt;/span> &lt;span class="kr">of&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Nothing&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Just&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- the optimzed version&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">safeDiv&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">\&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">\&lt;/span>&lt;span class="n">w&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">w&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">\&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¥½åƒï¼Œæœ‰ç‚¹åå‘ä¼˜åŒ–äº†ï¼Ÿæ²¡äº‹ï¼Œhaskell ä¸ºè¿™ä¸ªæ¨¡å¼è®¾è®¡äº† &lt;code>do&lt;/code> è¯­æ³•ç³–ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">val&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kr">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span> &lt;span class="ow">&amp;lt;-&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="n">b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">y&lt;/span> &lt;span class="ow">&amp;lt;-&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="n">c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">z&lt;/span> &lt;span class="ow">&amp;lt;-&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="n">d&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">z&lt;/span> &lt;span class="n">e&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç®€æ´ï¼Œå¥½çœ‹ï¼Œelegantï¼è¿™å°±æ˜¯â€œæ‰€è°“çš„â€ monad äº†ï¼å½“ç„¶ï¼Œå› ä¸ºæ ‡å‡†åº“é‡Œ&lt;a href="https://hackage.haskell.org/package/base-4.17.0.0/docs/Data-Maybe.html">å·²ç»æä¾›&lt;/a>äº† &lt;code>instance Monad Maybe&lt;/code> äº†ï¼Œæ‰€ä»¥æœ€åçš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦å†å®šä¹‰ä»»ä½•å…¶ä»–å‡½æ•°äº†ï¼Œåªéœ€è¦ä¿ç•™ &lt;code>safeDiv&lt;/code> å°±å¯ä»¥äº†ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿèƒ½è‡ªè¡Œå®ç°å„ç§å„æ ·çš„ functorï¼Œæœ‰ç‚¹åƒæ˜¯ OOP çš„æ¥å£ä¸€æ ·ï¼ˆç¬‘ï¼‰ã€‚&lt;/p>
&lt;h2 id="functor-and-monad">Functor and Monad&lt;/h2>
&lt;p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„ &lt;code>fmap'&lt;/code> æ˜¯è‡ªå·±å®šä¹‰çš„ï¼Œè€Œå®˜æ–¹é’ˆå¯¹ &lt;a href="https://hackage.haskell.org/package/base-4.17.0.0/docs/src/GHC.Base.html">&lt;code>Maybe&lt;/code> å®ç°çš„ &lt;code>fmap&lt;/code>&lt;/a> æ˜¯ä¸å¤ªä¸€æ ·çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- | @since 2.01&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">instance&lt;/span> &lt;span class="kt">Functor&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kr">where&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fmap&lt;/span> &lt;span class="kr">_&lt;/span> &lt;span class="kt">Nothing&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fmap&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Just&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Just&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">-- notice here!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬çš„ä¾‹å­ä¸­æ¨¡å¼åŒ¹é…é¡¹æ˜¯ &lt;code>Just x -&amp;gt; f x&lt;/code>ï¼Œä½†æ˜¯å®˜æ–¹çš„å´æ˜¯ &lt;code>Just a -&amp;gt; Just (f a)&lt;/code>ï¼Œåè€…å…¶å®æ‰æ˜¯æ ‡å‡†æ ¼å¼ï¼›&lt;code>safeDiv&lt;/code> è¿™ä¸ªä¾‹å­ä¸åŒæ˜¯å› ä¸ºæˆ‘ä»¬å®Œå…¨æ˜¯æ ¹æ®å‡½æ•°ç±»å‹æ¥â€œç‰¹åŒ–â€çš„ä¸€ä¸ªï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- safeDiv version of fmap&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fmap&lt;/span> &lt;span class="ow">::&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Int&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kt">Int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- haskell fmap, f is functor, eq to `Maybe`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fmap&lt;/span> &lt;span class="ow">::&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="n">b&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°å·®å¼‚åœ¨ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹ä¸Šã€‚è¿™é‡Œæè¿™ä¸ªåŒºåˆ«æ˜¯å› ä¸ºè¿™é‡Œè¦å¼€å§‹åŒºåˆ† functor å’Œ monad äº†ã€‚å‰æ–‡çš„ä¾‹å­ä¸­å¯èƒ½å¤§å®¶ä¼šè§‰å¾— monad è·Ÿ functor æ˜¯ä¸€å›äº‹ï¼Œå®é™…ä¸Šæ˜¯å­˜åœ¨å·®å¼‚çš„ã€‚Haskell å®šä¹‰äº† &lt;a href="https://wiki.haskell.org/Functor-Applicative-Monad_Proposal">Functor-Applicative-Monad&lt;/a> ç»“æ„ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯ applicative å¿…å®šæ˜¯ functorï¼Œmonad å¿…å®šæ˜¯ applicativeï¼Œä¸‰è€…æœ‰ç»§æ‰¿å…³ç³»ï¼Œæ‰€ä»¥ functor å…¶å®æ˜¯æ€§è´¨æ˜¯æ¯”è¾ƒå¼±çš„ã€‚&lt;/p>
&lt;p>è¿™éƒ¨åˆ†ä¸»è¦ä¼šæ ¹æ®å“”ç«™&lt;a href="https://www.bilibili.com/video/BV1qh411q7cS">é¹¤ç¿”ä¸‡é‡Œçš„è§†é¢‘&lt;/a>è¿›è¡Œä¸€å®šçš„ç»†è‡´é˜è¿°ï¼Œä¹Ÿä¼šå¯¹å‰æ–‡åˆ˜æœˆåŠå¤§ç¥çš„æ–‡ç« è¿›è¡Œå†è¡¥å……ã€‚å…ˆä» functor å¼€å§‹å§ï¼Œå®ƒçš„ä½œç”¨çœ‹ä¸Šé¢å‡½æ•°å®šä¹‰å°±èƒ½ç•¥çŸ¥ä¸€äºŒäº†ï¼Œç»™å®šä¸€ä¸ªä¸€èˆ¬çš„å‡½æ•°ï¼Œè®©å®ƒå»å¤„ç†â€œè£…ç®±â€åçš„ç±»å‹ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªåŒæ ·è¢«è£…ç®±äº†çš„ç±»å‹ï¼Œçœ‹ haskell çš„ &lt;code>Maybe&lt;/code> å®ç°å°±çŸ¥é“äº†ï¼Œè¿™é‡Œè´´å‡ºæ¥è§†é¢‘çš„å‡ ä¸ªä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- instance Functor Maybe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fmap&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Just&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Just&lt;/span> &lt;span class="mi">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fmap&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">Nothing&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- instance Functor []&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fmap&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ç„¶ functor æ ¹æ®å®šä¹‰ï¼Œå®ƒçš„å±€é™æ€§å°±åœ¨äºåªèƒ½å¤„ç†å€¼ï¼Œå¯¹äºå‡½æ•°ï¼Œå®ƒåªä¼šè¿”å›ä¸€ä¸ªè£…ç®±åçš„å‡½æ•°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fmap&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Just&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Just&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¹¶ä¸”æˆ‘ä»¬æ— æ³•ç»§ç»­å¾€ä¸‹è¿›è¡Œäº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fmap&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Just&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Just&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="err">ğŸ¤¯&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ—¶å°±éœ€è¦å¼•å…¥ applicative æ¥å¤„ç†äº†ï¼Œç›´æ¥çœ‹å®˜æ–¹å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- | @since 2.01&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">instance&lt;/span> &lt;span class="kt">Applicative&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kr">where&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pure&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Just&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Just&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="o">&amp;lt;*&amp;gt;&lt;/span> &lt;span class="n">m&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">fmap&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="n">m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Nothing&lt;/span> &lt;span class="o">&amp;lt;*&amp;gt;&lt;/span> &lt;span class="n">_m&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">liftA2&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Just&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Just&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Just&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">liftA2&lt;/span> &lt;span class="kr">_&lt;/span> &lt;span class="kr">_&lt;/span> &lt;span class="kr">_&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Just&lt;/span> &lt;span class="n">_m1&lt;/span> &lt;span class="o">*&amp;gt;&lt;/span> &lt;span class="n">m2&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">m2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Nothing&lt;/span> &lt;span class="o">*&amp;gt;&lt;/span> &lt;span class="n">_m2&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸»è¦å…³æ³¨ &lt;code>&amp;lt;*&amp;gt;&lt;/code> è¿™ä¸ªå‡½æ•°ï¼ˆè¯»ä½œ applyï¼‰ï¼Œå¯ä»¥çœ‹åˆ° applicative å°† &lt;code>Just (+3)&lt;/code> é‡Œé¢çš„ &lt;code>(+3)&lt;/code> å‡½æ•°ç»™å–å‡ºæ¥äº†ï¼Œç„¶åé€šè¿‡ &lt;code>fmap&lt;/code> åº”ç”¨å‡½æ•°ï¼Œè¿™æ ·å¾—åˆ°çš„ç»“æœä¾ç„¶æ˜¯ä¸ª &lt;code>Maybe&lt;/code> ç±»å‹ï¼Œit just worksã€‚&lt;/p>
&lt;p>åŒæ ·ï¼Œè´´ä¸Šè§†é¢‘ä¸­çš„å‡ ä¸ªä¾‹å­å½“ä½œ memoï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- instance Applicative Maybe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">Just&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;lt;*&amp;gt;&lt;/span> &lt;span class="kt">Just&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Just&lt;/span> &lt;span class="mi">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- instance Applicative []&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[(&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)]&lt;/span> &lt;span class="o">&amp;lt;*&amp;gt;&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœæˆ‘ä»¬æŠŠå‰æ–‡ä¾‹å­ä¸­ &lt;code>safeDiv&lt;/code> é‡Œçš„ &lt;code>fmap'&lt;/code> åˆ å»ï¼Œé‚£ä¹ˆä¸‹é¢è¿™ä¸ªå‡½æ•°å°±ä¼šå¼€å§‹å‡ºç±»å‹é”™è¯¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- without customized fmap function&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">let&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="c1">-- ç¬¬ä¸€å±‚ a/b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">y&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">fmap&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">\&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="c1">-- ç¬¬äºŒå±‚ (a/b)/c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">z&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">fmap&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">\&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="c1">-- ç¬¬ä¸‰å±‚ (a/b/c)/d&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fmap&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">\&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">z&lt;/span> &lt;span class="c1">-- ç¬¬å››å±‚ (a/b/c/d)/e&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŸå› å‰æ–‡è¯´äº†ï¼Œ&lt;code>fmap&lt;/code> å…¶å®è¿”å›çš„æ˜¯ &lt;code>Just (f a)&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fmap&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">\&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Just&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Just&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Just&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™å°±æœ‰ç‚¹éš¾å—äº†ï¼Œä¸æ˜¯æˆ‘ä»¬é¢„æœŸæƒ³è¦çš„ &lt;code>Just 10&lt;/code>ã€‚è¿™ç§æƒ…å†µä¸‹å°±éœ€è¦ä½¿ç”¨ monad äº†ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢å®šä¹‰ä¸­ &lt;code>&amp;gt;&amp;gt;=&lt;/code>ï¼ˆè¯»ä½œ bindï¼‰æ¥è¿›è¡Œå¤„ç†äº†ï¼Œä¹Ÿæ˜¯ç›´æ¥çœ‹å®˜æ–¹ä»£ç å§ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- | @since 2.01&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">instance&lt;/span> &lt;span class="kt">Monad&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="kr">where&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="kt">Just&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">Nothing&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="kr">_&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&amp;gt;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹æ¯”å®˜æ–¹ &lt;code>fmap&lt;/code> å°±èƒ½çœ‹åˆ°ï¼Œmonad çš„ instance ä¸­ä¸å†æ˜¯ &lt;code>Just (k x)&lt;/code>ï¼Œè€Œæ˜¯ç®€ä»‹ã€æ˜äº†çš„ &lt;code>k x&lt;/code>ï¼Œneatã€‚è¿™ä¹Ÿæ˜¯è·Ÿæˆ‘ä»¬åœ¨ &lt;code>safeDiv&lt;/code> ä¸­å®ç°çš„ &lt;code>&amp;gt;&amp;gt;=&lt;/code> ç‰ˆæœ¬å®Œå…¨ç­‰ä»·ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯ä¸€ä¸ª monadã€‚&lt;/p>
&lt;p>ä¾ç„¶ï¼Œè´´ä¸Šä¸€äº›è§†é¢‘ä¸­çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">Just&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="nf">\&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Just&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Just&lt;/span> &lt;span class="mi">4&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ªäººç†è§£ï¼Œæ— è®ºæ˜¯ functorã€applicative è¿˜æ˜¯ monadï¼Œå®ƒä»¬æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸ºäº†æ›´å¥½åœ°å¤„ç†â€œè¢«è£…ç®±çš„ç±»å‹â€ã€‚è€Œ haskell æ¯”è¾ƒæ¨å´‡è¿™ç§ç›’å­æ¨¡å¼ï¼Œå¾ˆå¤šç±»å‹åƒ &lt;code>Maybe a&lt;/code>ã€&lt;code>IO a&lt;/code> è¿™ç§ï¼Œéƒ½å®ç°äº† monad çš„ bind è¿ç®—ç¬¦ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ Haskell é‡Œå¸¸ç”¨çš„æ•°ç»„å±•å¼€ï¼Œå…¶å®ä¹Ÿæ˜¯å€ŸåŠ© functor æ¥å®Œæˆçš„ï¼Œæ¥è‡ª&lt;a href="https://zhuanlan.zhihu.com/p/39734882">è¯„è®ºåŒºçš„ Narc å¤§ç¥&lt;/a>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- original&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="ow">&amp;lt;-&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="ow">&amp;lt;-&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- desuger&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="nf">\&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="nf">\&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="n">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦å¤– JavaScript çš„ &lt;code>Promise&lt;/code> ä¹Ÿæ˜¯è·Ÿ monad æœ‰ç‚¹â€œå¼‚æ›²åŒå·¥â€ä¹‹å¦™çš„ï¼Œæ¯•ç«Ÿ lazy eval èƒ½çœ‹ä½œæ˜¯å¼‚æ­¥ï¼ˆã€‚&lt;/p>
&lt;h2 id="myth">Myth&lt;/h2>
&lt;p>æˆ‘ä¸ªäººä¾ç„¶æœ‰ä¸€äº›è¿·æ€ï¼Œå¯èƒ½éœ€è¦ç³»ç»Ÿåœ°å­¦ä¹ ä¸‹èŒƒç•´è®ºæ‰èƒ½è§£æƒ‘äº†ã€‚&lt;/p>
&lt;ol>
&lt;li>éƒ½è¯´ monad èƒ½éš”ç¦»å‰¯ä½œç”¨ï¼Œä½†æ˜¯æˆ‘çœ‹ä¸‹ï¼Œæ„Ÿè§‰è·Ÿé—­åŒ…å·®ä¸å¤šï¼Ÿå°†æ‰€æœ‰çŠ¶æ€è£…ç®±åˆ°ä¸€ä¸ªé—­åŒ…ä¸­ï¼Œå½“ç„¶å¤–éƒ¨æ— æ³•ä¿®æ”¹ï¼Œ&lt;a href="https://stackoverflow.com/a/79077">Stack Overflow ä¸Šä¹Ÿæœ‰è®¨è®º&lt;/a>ï¼Œè¯´åŒºåˆ«åœ¨äºâ€œA monad is (roughly) more like a context in which functions can be chained together sequentially, and controls how data is passed from one function to the next.â€&lt;/li>
&lt;li>å¯¹ç”¨æ³•ä¾ç„¶ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œæš‚æ—¶çš„æƒ³æ³•æ˜¯ï¼Œmonad å°±æ˜¯ç”¨æ¥å¤„ç†â€œç›’å­â€çš„ï¼Œside effect å¯ä»¥è£…è¿›ç›’å­ä¸­ï¼Œerror handling ä¹Ÿå¯ä»¥è£…è¿›å»ï¼Œç­‰ç­‰ï¼›å¹¶ä¸” monad å¯ä»¥â€œä¼ é€’â€ï¼ˆä¸åŒäº closure åªèƒ½æ•è·å‡½æ•°å†…çš„ï¼Œmonad å¯ä»¥æ•è·æ•´ä¸ªé“¾å¼è°ƒç”¨ä¸Šçš„ç»“æœ)ï¼ŒåŠ ä¸Š &lt;code>return&lt;/code> å‡½æ•°çš„è¾…åŠ©ï¼Œå®¹æ˜“å®ç° chain callï¼Œå¹¶ä¸” chain ä¸Šçš„å‡½æ•°éƒ½å…±äº«æ•´ä¸ª contextï¼Ÿ&lt;/li>
&lt;li>ä¸€ä¸ªè‡ªå‡½å­èŒƒç•´ä¸Šçš„å¹ºåŠç¾¤ã€‚ã€‚å—¯ï¼Œè¿˜æ˜¯ä¸å¤ªæ‡‚ğŸ˜‚&lt;/li>
&lt;/ol>
&lt;p>è¿˜æœ‰ï¼ŒåŸçŸ¥ä¹å¸–å­é‡Œè®²è¿°äº†ä¸€ä¸ª &lt;code>join&lt;/code> æ“ä½œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-haskell" data-lang="haskell">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">let&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">safeDiv&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="n">b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">y&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">fmap&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">safeDiv&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">z&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">fmap&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="n">fmap&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">safeDiv&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">y&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">in&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">fmap&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="n">fmap&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="n">fmap&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">safeDiv&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">z&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">join&lt;/span> &lt;span class="ow">::&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Maybe&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="n">a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">join&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">Just&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">join&lt;/span> &lt;span class="kt">Nothing&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="kt">Nothing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;=&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">::&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">-&amp;gt;&lt;/span> &lt;span class="kt">Maybe&lt;/span> &lt;span class="n">b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;=&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">mbx&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="ow">=&lt;/span> &lt;span class="n">join&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">fmap&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="n">mbx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸€éƒ¨åˆ†æˆ‘æš‚æ—¶è¿˜ä¸æ˜¯å¾ˆæ‡‚ï¼Œç­”ä¸»ç»™çš„ä¾‹å­ä¸­é‚£ä¸€ä¸² &lt;code>fmap&lt;/code> æˆ‘æš‚æ—¶è¿˜æ˜¯æ²¡èƒ½æ¨å¯¼å‡ºç±»å‹å‡ºæ¥ï¼ˆä¸å¤ªç†Ÿæ‚‰ &lt;code>.&lt;/code> æ“ä½œç¬¦ï¼Œæ˜¯ haskell è¶…é«˜æ ¡çº§çš„æ–°æ‰‹äº†ï¼‰ã€‚To be continuedã€‚&lt;/p>
&lt;p>å…¶å®è‡ªå·±è¿˜æ˜¯æœ‰æŒºå¤šåœ°æ–¹ä¸æ‡‚çš„ï¼Œä¸è¿‡ haskell å¯èƒ½æš‚æ—¶ä¸ä¼šå†å­¦ä¹ äº†ï¼Œç›®å‰å¯¹ erlang æ›´æœ‰å…´è¶£ä¸€äº›ï¼Œå­¦ä¸€é—¨è¯­è¨€ç­‰äºå­¦å®Œäº†å¹¶å‘èŒƒå¼ï¼Œä¸é¦™å—ä¸é¦™å—ï¼ˆå…¶å®ä¸»è¦æ˜¯æ•°å­¦å¤ªæ¸£äº†ï¼Œçœ‹äº†ä¸€å°ä¼šèŒƒç•´è®ºå°±å·²ç»å¼€å§‹æ­‡èœäº†ğŸ¤§ï¼‰ã€‚&lt;/p></description></item></channel></rss>